<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(6)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(6) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(6) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(6) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Process UbiSpec | UbiSpec</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Process UbiSpec" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Behavioural Specification Format for Software Systems" /> <meta property="og:description" content="Behavioural Specification Format for Software Systems" /> <link rel="canonical" href="http://0.0.0.0:4000/spec/process.html" /> <meta property="og:url" content="http://0.0.0.0:4000/spec/process.html" /> <meta property="og:site_name" content="UbiSpec" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Process UbiSpec" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Behavioural Specification Format for Software Systems","headline":"Process UbiSpec","url":"http://0.0.0.0:4000/spec/process.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <header class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> UbiSpec </a> <button id="menu-button" class="site-button btn-reset" aria-label="Menu" aria-expanded="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/guide/conceptual-foundations.html" class="nav-list-link">Conceptual Foundations</a></li><li class="nav-list-item"><a href="/guide/getting-started.html" class="nav-list-link">Getting Started</a></li><li class="nav-list-item"><a href="/guide/guide.html" class="nav-list-link">Guide</a></li><li class="nav-list-item"><a href="/spec/lifecycle.html" class="nav-list-link">Lifecycle UbiSpec</a></li><li class="nav-list-item"><a href="/spec/process.html" class="nav-list-link">Process UbiSpec</a></li><li class="nav-list-item"><a href="/examples/" class="nav-list-link">Examples</a></li><li class="nav-list-item"><a href="/guide/example-artifacts.html" class="nav-list-link">Example artifacts</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/mean-machine-gc/bspec" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <div class="d-md-block d-none site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </div> </header> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search UbiSpec" autocomplete="off"> <label for="search-input" class="search-label"> <span class="sr-only">Search UbiSpec</span> <svg viewBox="0 0 24 24" class="search-icon" aria-hidden="true"><use xlink:href="#svg-search"></use></svg> </label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/mean-machine-gc/bspec" class="site-button" > GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="process-ubispec"> <a href="#process-ubispec" class="anchor-heading" aria-labelledby="process-ubispec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Process UbiSpec </h1> <p><strong>Behavioural Specification Format for Cross-Aggregate Coordination</strong></p> <p>Version: 0.4.0 Part of: UbiSpec (Behavioural Specification Format for Software Systems)</p><hr /> <h2 id="1-purpose"> <a href="#1-purpose" class="anchor-heading" aria-labelledby="1-purpose"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Purpose </h2> <p>A Process UbiSpec describes the coordination logic between aggregates. It captures:</p> <ul> <li>Which events trigger cross-aggregate reactions</li> <li>Under what conditions each reaction proceeds</li> <li>Which commands are dispatched to which target deciders</li> <li>What must be true about the commands produced</li> </ul> <p>A process manager sits between deciders. It subscribes to events from source deciders and dispatches commands to target deciders. It may be stateless (a reactor) or stateful (a saga).</p> <p>A Process UbiSpec only describes <strong>active reactions</strong>. If an event is observed and no conditions are met, no commands are dispatched — this is a valid no-op that does not need to be specified.</p> <h2 id="2-scope"> <a href="#2-scope" class="anchor-heading" aria-labelledby="2-scope"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Scope </h2> <p>One Process UbiSpec per process manager. A system may have zero or many process managers. Each coordinates between two or more aggregates whose lifecycles are described in Lifecycle UbiSpec.</p> <h2 id="3-relationship-to-model-and-lifecycle-specs"> <a href="#3-relationship-to-model-and-lifecycle-specs" class="anchor-heading" aria-labelledby="3-relationship-to-model-and-lifecycle-specs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Relationship to Model and Lifecycle Specs </h2> <p>A Process UbiSpec references the same TypeScript model as the Lifecycle UbiSpec it coordinates. It also references the Lifecycle UbiSpec themselves — the event names in <code class="language-plaintext highlighter-rouge">When</code> must match events specified in the source decider’s lifecycle, and the command names in <code class="language-plaintext highlighter-rouge">Then</code> must match commands specified in the target decider’s lifecycle.</p> <p>This cross-reference is the <strong>contract boundary</strong>: the process manager is guaranteed to receive events with the shapes defined by the source decider, and must emit commands with the shapes expected by the target decider.</p> <h2 id="4-document-structure"> <a href="#4-document-structure" class="anchor-heading" aria-labelledby="4-document-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Document Structure </h2> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">process/v1</span>

<span class="na">process</span><span class="pi">:</span> <span class="s">&lt;ProcessManagerName&gt;</span>
<span class="na">reacts_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">&lt;DeciderName&gt;</span><span class="pi">,</span> <span class="nv">...</span><span class="pi">]</span>
<span class="na">emits_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">&lt;DeciderName&gt;</span><span class="pi">,</span> <span class="nv">...</span><span class="pi">]</span>
<span class="na">model</span><span class="pi">:</span> <span class="s">&lt;path to TypeScript model file&gt;</span>

<span class="na">state</span><span class="pi">:</span>
  <span class="na">&lt;fieldName&gt;</span><span class="pi">:</span> <span class="s">&lt;TypeScript type&gt;</span>

<span class="na">common</span><span class="pi">:</span>
  <span class="na">&lt;predicate-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>

<span class="na">reactions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">&lt;trigger&gt;</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">&lt;source&gt;</span>
    <span class="na">And</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">&lt;command specification&gt;</span>
    <span class="na">Outcome</span><span class="pi">:</span> <span class="s">&lt;assertions&gt;</span>
</code></pre></div></div> <h3 id="41-header"> <a href="#41-header" class="anchor-heading" aria-labelledby="41-header"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.1 Header </h3> <div class="table-wrapper"><table> <thead> <tr> <th>Field</th> <th>Required</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">bspec</code></td> <td>Yes</td> <td>Format identifier. Must be <code class="language-plaintext highlighter-rouge">process/v1</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">process</code></td> <td>Yes</td> <td>Process manager name. PascalCase.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">reacts_to</code></td> <td>Yes</td> <td>List of decider names whose events this process manager subscribes to.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">emits_to</code></td> <td>Yes</td> <td>List of decider names to which this process manager dispatches commands.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">model</code></td> <td>Yes</td> <td>Relative path to the TypeScript model file.</td> </tr> </tbody> </table></div> <p>The <code class="language-plaintext highlighter-rouge">reacts_to</code> and <code class="language-plaintext highlighter-rouge">emits_to</code> lists declare the <strong>topology</strong> — which aggregates this process manager connects. An agent can extract the full system wiring diagram from these declarations.</p> <h3 id="42-state"> <a href="#42-state" class="anchor-heading" aria-labelledby="42-state"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.2 State </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">state</span><span class="pi">:</span>
  <span class="na">&lt;fieldName&gt;</span><span class="pi">:</span> <span class="s">&lt;TypeScript type&gt;</span>
</code></pre></div></div> <p>Optional. Only present for <strong>stateful sagas</strong> — process managers that need to track custom state beyond what <code class="language-plaintext highlighter-rouge">When: { all: [...] }</code> handles automatically. See §9 for when manual state is appropriate.</p> <p>When present, the state fields are available as <code class="language-plaintext highlighter-rouge">rm.state</code> in predicates and the reaction’s outcome can assert on <code class="language-plaintext highlighter-rouge">om.state</code>.</p> <h3 id="43-common"> <a href="#43-common" class="anchor-heading" aria-labelledby="43-common"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.3 Common </h3> <p>Same as Lifecycle UbiSpec §4.2. Reusable predicates referenced by bare name.</p> <h2 id="5-reaction"> <a href="#5-reaction" class="anchor-heading" aria-labelledby="5-reaction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Reaction </h2> <p>Each element under <code class="language-plaintext highlighter-rouge">reactions</code> specifies the behaviour for one event-triggered reaction.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">reactions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">&lt;trigger&gt;</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">&lt;source&gt;</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="s">&lt;constraints&gt;</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">&lt;commands&gt;</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="s">&lt;assertions&gt;</span>
</code></pre></div></div> <h3 id="51-when--from--trigger"> <a href="#51-when--from--trigger" class="anchor-heading" aria-labelledby="51-when--from--trigger"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.1 When + From — Trigger </h3> <p>Together, these identify the trigger: which event(s) from which decider(s) cause the reaction to fire.</p> <p>Three forms exist, addressing three distinct coordination patterns:</p> <h4 id="scalar--single-event"> <a href="#scalar--single-event" class="anchor-heading" aria-labelledby="scalar--single-event"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scalar — Single Event </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span> <span class="s">OrderPlaced</span>
<span class="na">From</span><span class="pi">:</span> <span class="s">Order</span>
</code></pre></div></div> <p>One event from one decider. The simplest form. The reaction fires once when this specific event occurs.</p> <h4 id="any--one-of-several-events-or"> <a href="#any--one-of-several-events-or" class="anchor-heading" aria-labelledby="any--one-of-several-events-or"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Any — One of Several Events (OR) </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">any</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">AssessmentSubmittedFullyMet</span><span class="pi">,</span> <span class="nv">AssessmentSubmittedWithGaps</span><span class="pi">]</span>
<span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
</code></pre></div></div> <p>The reaction fires when <strong>any one</strong> of the listed events occurs. This is an OR — exactly one event fires, and the reaction runs once for that event.</p> <p>Rules:</p> <ul> <li>All listed events must come from the same decider (named in <code class="language-plaintext highlighter-rouge">From</code>).</li> <li>All listed events must be defined in the source decider’s Lifecycle UbiSpec.</li> <li>Each invocation receives exactly one event. <code class="language-plaintext highlighter-rouge">rm.event</code> is typed as the discriminated union of the listed events. Use <code class="language-plaintext highlighter-rouge">rm.event.kind</code> to distinguish variants (§7.1).</li> </ul> <p><strong>Use <code class="language-plaintext highlighter-rouge">any</code> when</strong> multiple events represent variants of the same domain occurrence and the reaction logic is mostly identical, with small differences handled by conditional commands or event narrowing.</p> <h4 id="all--wait-for-multiple-events-and"> <a href="#all--wait-for-multiple-events-and" class="anchor-heading" aria-labelledby="all--wait-for-multiple-events-and"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> All — Wait for Multiple Events (AND) </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">all</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">PaymentConfirmed from Payment</span>
    <span class="pi">-</span> <span class="s">InventoryReserved from Inventory</span>
<span class="na">correlate</span><span class="pi">:</span> <span class="s">orderId</span>
</code></pre></div></div> <p>The reaction fires only when <strong>all</strong> listed events have arrived for the same correlated instance. This is an AND — the runtime accumulates events until the set is complete, then fires the reaction once with all event payloads accessible.</p> <p>Rules:</p> <ul> <li>Events can come from different deciders. Each event is annotated with its source decider using the <code class="language-plaintext highlighter-rouge">EventName from DeciderName</code> syntax.</li> <li>All listed deciders must appear in <code class="language-plaintext highlighter-rouge">reacts_to</code>.</li> <li>All listed events must be defined in their respective source decider’s Lifecycle UbiSpec.</li> <li>The <code class="language-plaintext highlighter-rouge">correlate</code> field declares which field links the events to the same instance. The named field must exist on every listed event.</li> <li><code class="language-plaintext highlighter-rouge">From</code> is not used. Source deciders are declared per-event.</li> <li>Events may arrive in any order. The runtime handles accumulation.</li> <li>When all events have arrived, each event payload is accessible by name: <code class="language-plaintext highlighter-rouge">rm.events.PaymentConfirmed</code>, <code class="language-plaintext highlighter-rouge">rm.events.InventoryReserved</code> (§7.1). There is no union — each event has its concrete type.</li> </ul> <p><strong>Use <code class="language-plaintext highlighter-rouge">all</code> when</strong> multiple events must have occurred before the reaction can proceed — the scatter-gather or join pattern.</p> <p><strong>When all events come from the same decider</strong>, the source can be written once:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">all</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">OrderPlaced</span><span class="pi">,</span> <span class="nv">OrderApproved</span><span class="pi">]</span>
<span class="na">From</span><span class="pi">:</span> <span class="s">Order</span>
<span class="na">correlate</span><span class="pi">:</span> <span class="s">orderId</span>
</code></pre></div></div> <p>This is equivalent to annotating each event with <code class="language-plaintext highlighter-rouge">from Order</code>. The <code class="language-plaintext highlighter-rouge">From</code> field is valid with <code class="language-plaintext highlighter-rouge">all</code> when all events share the same source.</p> <h4 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h4> <div class="table-wrapper"><table> <thead> <tr> <th>Form</th> <th>Syntax</th> <th>Fires when</th> <th>rm namespace</th> <th>From</th> </tr> </thead> <tbody> <tr> <td>Scalar</td> <td><code class="language-plaintext highlighter-rouge">When: EventName</code></td> <td>Event occurs</td> <td><code class="language-plaintext highlighter-rouge">rm.event</code> (concrete)</td> <td>Required</td> </tr> <tr> <td>Any</td> <td><code class="language-plaintext highlighter-rouge">When: { any: [...] }</code></td> <td>Any one event occurs</td> <td><code class="language-plaintext highlighter-rouge">rm.event</code> (union)</td> <td>Required (shared)</td> </tr> <tr> <td>All</td> <td><code class="language-plaintext highlighter-rouge">When: { all: [...] }</code> + <code class="language-plaintext highlighter-rouge">correlate</code></td> <td>All events have arrived</td> <td><code class="language-plaintext highlighter-rouge">rm.events.EventName</code> (each concrete)</td> <td>Per-event or shared</td> </tr> </tbody> </table></div> <h3 id="52-and--constraints"> <a href="#52-and--constraints" class="anchor-heading" aria-labelledby="52-and--constraints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.2 And — Constraints </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">And</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">&lt;constraint-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="pi">-</span> <span class="s">&lt;constraint-name&gt;</span>
</code></pre></div></div> <p>Same semantics as Lifecycle UbiSpec §5.2. All constraints must hold for the reaction to proceed. If any fails, no commands are dispatched.</p> <p>For <code class="language-plaintext highlighter-rouge">all</code> triggers, constraints are evaluated <strong>after</strong> all events have arrived. The constraint predicates have access to every event payload via <code class="language-plaintext highlighter-rouge">rm.events</code>.</p> <p>Constraints are evaluated against the <strong>Reaction Model</strong> (§7).</p> <p><code class="language-plaintext highlighter-rouge">And</code> is optional. A reaction with no constraints always proceeds.</p> <p><strong>No implicit failure event.</strong> Unlike deciders, process managers do not emit <code class="language-plaintext highlighter-rouge">DecisionFailed</code>. A process manager that doesn’t react simply does nothing. The event was observed; no action was needed. This is by design — the source event is a fact that already happened, and the process manager’s silence is a valid outcome.</p> <h3 id="53-then--commands"> <a href="#53-then--commands" class="anchor-heading" aria-labelledby="53-then--commands"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.3 Then — Commands </h3> <p>Specifies which commands are dispatched on reaction. Each command is annotated with its target decider using <code class="language-plaintext highlighter-rouge">-&gt; DeciderName</code>.</p> <h4 id="scalar-form"> <a href="#scalar-form" class="anchor-heading" aria-labelledby="scalar-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scalar Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span> <span class="s">&lt;CommandName&gt; -&gt; &lt;DeciderName&gt;</span>
</code></pre></div></div> <p>Shorthand. Dispatches exactly one command, unconditionally.</p> <h4 id="list-form"> <a href="#list-form" class="anchor-heading" aria-labelledby="list-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> List Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">&lt;CommandName&gt; -&gt; &lt;DeciderName&gt;</span>
  <span class="pi">-</span> <span class="na">&lt;CommandName&gt; -&gt; &lt;DeciderName&gt;</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">&lt;condition-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="pi">-</span> <span class="s">&lt;CommandName&gt; -&gt; &lt;DeciderName&gt;</span>
</code></pre></div></div> <p>Each entry is a command that may or may not be dispatched:</p> <ul> <li><strong>Unconditional command</strong>: bare <code class="language-plaintext highlighter-rouge">CommandName -&gt; DeciderName</code>. Always dispatched on reaction.</li> <li><strong>Conditional command</strong>: command with conditions. Dispatched only when all conditions hold.</li> </ul> <p>Rules:</p> <ul> <li><strong>All qualifying commands are dispatched.</strong> Additive, same as Lifecycle UbiSpec events.</li> <li>Commands are dispatched <strong>in list order</strong>. Order matters — a target decider may reject a command if a prior command hasn’t been processed first.</li> <li>Conditions are evaluated against the <strong>Reaction Model</strong> (§7).</li> <li>If all commands are conditional and none match, no commands are dispatched (valid no-op).</li> <li>The <code class="language-plaintext highlighter-rouge">-&gt; DeciderName</code> must reference a decider in <code class="language-plaintext highlighter-rouge">emits_to</code>.</li> <li>The <code class="language-plaintext highlighter-rouge">CommandName</code> must match a command in the target decider’s Lifecycle UbiSpec.</li> </ul> <h4 id="patterns"> <a href="#patterns" class="anchor-heading" aria-labelledby="patterns"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Patterns </h4> <p><strong>Single unconditional command</strong>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
</code></pre></div></div> <p><strong>Multiple unconditional commands</strong> (ordered sequence):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">WithdrawAssignment -&gt; Laboratory</span>
  <span class="pi">-</span> <span class="s">AssignProfile -&gt; Laboratory</span>
</code></pre></div></div> <p><strong>Conditional command</strong> (only when conditions met):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">WithdrawAssignment -&gt; Laboratory</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-active-assignment</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">rm.ctx.laboratory.assignments.some(a =&gt;</span>
            <span class="s">a.area.kind === rm.event.area.kind)</span>
</code></pre></div></div> <p><strong>Mixed</strong> (base + conditional):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
  <span class="pi">-</span> <span class="na">NotifyCompliance -&gt; Notification</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">is-regulated-area</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.area.regulated</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">true"</span>
</code></pre></div></div> <p><strong>Multi-target</strong> (commands to different deciders):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ArchiveRegistry -&gt; Registry</span>
  <span class="pi">-</span> <span class="s">TriggerReassessment -&gt; Laboratory</span>
</code></pre></div></div> <p><strong>Event-discriminated with <code class="language-plaintext highlighter-rouge">any</code></strong> (different commands for different triggering events):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">any</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">OrderPlaced</span><span class="pi">,</span> <span class="nv">OrderConfirmed</span><span class="pi">]</span>
<span class="na">From</span><span class="pi">:</span> <span class="s">Order</span>
<span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">ReserveInventory -&gt; Inventory</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">is-placement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'OrderPlaced'"</span>
  <span class="pi">-</span> <span class="na">ScheduleShipment -&gt; Fulfillment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">is-confirmation</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'OrderConfirmed'"</span>
</code></pre></div></div> <p><strong>Cross-event data assembly with <code class="language-plaintext highlighter-rouge">all</code></strong> (combine data from both events):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">all</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">PaymentConfirmed from Payment</span>
    <span class="pi">-</span> <span class="s">InventoryReserved from Inventory</span>
<span class="na">correlate</span><span class="pi">:</span> <span class="s">orderId</span>
<span class="na">Then</span><span class="pi">:</span> <span class="s">ScheduleShipment -&gt; Fulfillment</span>
<span class="na">Outcome</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">uses-payment-data</span><span class="pi">:</span> <span class="pi">&gt;</span>
      <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
        <span class="s">.amount === rm.events.PaymentConfirmed.amount</span>
  <span class="pi">-</span> <span class="na">uses-inventory-data</span><span class="pi">:</span> <span class="pi">&gt;</span>
      <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
        <span class="s">.lines === rm.events.InventoryReserved.reservedLines</span>
</code></pre></div></div> <h3 id="54-outcome--assertions"> <a href="#54-outcome--assertions" class="anchor-heading" aria-labelledby="54-outcome--assertions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.4 Outcome — Assertions </h3> <p>Specifies what must be true about the commands dispatched. Two forms:</p> <h4 id="flat-form"> <a href="#flat-form" class="anchor-heading" aria-labelledby="flat-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Flat Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Outcome</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
</code></pre></div></div> <p>A flat list. All assertions must hold.</p> <h4 id="keyed-form"> <a href="#keyed-form" class="anchor-heading" aria-labelledby="keyed-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Keyed Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Outcome</span><span class="pi">:</span>
  <span class="na">_always</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="na">&lt;CommandName&gt; -&gt; &lt;DeciderName&gt;</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
</code></pre></div></div> <p>Assertions grouped by relevance:</p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">_always</code></strong>: assertions that hold for every reaction execution.</li> <li><strong>Command-keyed sections</strong>: assertions evaluated only when that command was dispatched.</li> </ul> <p>The key format is <code class="language-plaintext highlighter-rouge">CommandName -&gt; DeciderName</code>, matching the Then entries.</p> <p>All assertions use the <strong>Outcome Model</strong> (§8).</p> <h2 id="6-predicate-entry"> <a href="#6-predicate-entry" class="anchor-heading" aria-labelledby="6-predicate-entry"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Predicate Entry </h2> <p>Same as Lifecycle UbiSpec §6. All four detail levels apply — name only, scope annotation, prose description, and executable expression. Levels can be mixed within a single spec.</p> <p>For process manager predicates, scope annotations reference <code class="language-plaintext highlighter-rouge">rm.*</code> and <code class="language-plaintext highlighter-rouge">om.*</code> namespaces instead of <code class="language-plaintext highlighter-rouge">dm.*</code>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Level 1: name only</span>
<span class="pi">-</span> <span class="s">has-active-assignment</span>

<span class="c1"># Level 2: scope annotation</span>
<span class="pi">-</span> <span class="na">has-active-assignment</span><span class="pi">:</span> <span class="s">rm.ctx</span>
<span class="pi">-</span> <span class="na">correct-amount</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">rm.events.PaymentConfirmed</span><span class="pi">,</span> <span class="nv">om.commands</span><span class="pi">]</span>

<span class="c1"># Level 3: prose</span>
<span class="pi">-</span> <span class="na">has-active-assignment</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Target</span><span class="nv"> </span><span class="s">laboratory</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">active</span><span class="nv"> </span><span class="s">assignment</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">area</span><span class="nv"> </span><span class="s">(rm.ctx)"</span>

<span class="c1"># Level 4: executable</span>
<span class="pi">-</span> <span class="na">has-active-assignment</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.ctx.laboratory.assignments.some(a</span><span class="nv"> </span><span class="s">=&gt;</span><span class="nv"> </span><span class="s">a.area.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">rm.event.area.kind)"</span>
</code></pre></div></div> <h2 id="7-reaction-model-rm"> <a href="#7-reaction-model-rm" class="anchor-heading" aria-labelledby="7-reaction-model-rm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Reaction Model (rm) </h2> <p>The input context for process manager constraints and command conditions.</p> <h3 id="71-rmevent--rmevents--triggering-events"> <a href="#71-rmevent--rmevents--triggering-events" class="anchor-heading" aria-labelledby="71-rmevent--rmevents--triggering-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1 rm.event / rm.events — Triggering Events </h3> <p>The namespace depends on the When form:</p> <h4 id="scalar-and-any--rmevent-singular"> <a href="#scalar-and-any--rmevent-singular" class="anchor-heading" aria-labelledby="scalar-and-any--rmevent-singular"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scalar and Any — <code class="language-plaintext highlighter-rouge">rm.event</code> (singular) </h4> <p>For scalar and <code class="language-plaintext highlighter-rouge">any</code> triggers, the reaction receives exactly one event. <code class="language-plaintext highlighter-rouge">rm.event</code> is a concrete runtime value — an object with a <code class="language-plaintext highlighter-rouge">kind</code> field and payload fields.</p> <p><strong>Scalar When</strong> — <code class="language-plaintext highlighter-rouge">rm.event</code> is that event’s type, directly accessible:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span> <span class="s">AssessmentConfirmed</span>
<span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
<span class="c1"># rm.event is an AssessmentConfirmed — all fields directly accessible</span>
<span class="na">And</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">has-reviewer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.reviewedBy.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
</code></pre></div></div> <p><strong>Any When</strong> — <code class="language-plaintext highlighter-rouge">rm.event</code> is a discriminated union. Use <code class="language-plaintext highlighter-rouge">rm.event.kind</code> to narrow:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">any</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">AssessmentSubmittedFullyMet</span><span class="pi">,</span> <span class="nv">AssessmentSubmittedWithGaps</span><span class="pi">]</span>
<span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
<span class="c1"># rm.event is one of the two types — narrow with .kind</span>
<span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
  <span class="pi">-</span> <span class="na">ForwardGaps -&gt; Laboratory</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-gaps</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'AssessmentSubmittedWithGaps'"</span>
</code></pre></div></div> <p><strong>Narrowing rules for <code class="language-plaintext highlighter-rouge">any</code>:</strong></p> <p>Fields common to all events in the union can be accessed directly without narrowing (e.g., <code class="language-plaintext highlighter-rouge">rm.event.laboratoryId</code> if all events carry it). Variant-specific fields require narrowing:</p> <p><strong>Inline narrowing with <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> (preferred):</strong> TypeScript narrows within a single <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> expression. Safe at runtime — short-circuit prevents invalid access:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">has-gaps</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'AssessmentSubmittedWithGaps'</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">rm.event.gaps.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
</code></pre></div></div> <p><strong>Conditional structure as narrowing context:</strong> A conditional command’s conditions establish which variant is present. Outcome assertions under that command’s key inherit the narrowing:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">ForwardGaps -&gt; Laboratory</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-gaps</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'AssessmentSubmittedWithGaps'"</span>
<span class="na">Outcome</span><span class="pi">:</span>
  <span class="na">ForwardGaps -&gt; Laboratory</span><span class="pi">:</span>
    <span class="c1"># Only evaluated when ForwardGaps dispatched → rm.event.kind is 'AssessmentSubmittedWithGaps'</span>
    <span class="pi">-</span> <span class="na">gaps-forwarded</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.commands.find(c</span><span class="nv"> </span><span class="s">=&gt;</span><span class="nv"> </span><span class="s">c.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'ForwardGaps').gaps</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">rm.event.gaps"</span>
</code></pre></div></div> <p><strong>Optional chaining as fallback:</strong></p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">gaps-if-present</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.gaps?.length</span><span class="nv"> </span><span class="s">??</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
</code></pre></div></div> <h4 id="all--rmevents-plural-keyed-by-event-name"> <a href="#all--rmevents-plural-keyed-by-event-name" class="anchor-heading" aria-labelledby="all--rmevents-plural-keyed-by-event-name"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> All — <code class="language-plaintext highlighter-rouge">rm.events</code> (plural, keyed by event name) </h4> <p>For <code class="language-plaintext highlighter-rouge">all</code> triggers, every event payload is accessible by its event name. Each is its own concrete type — no union, no narrowing needed:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span>
  <span class="na">all</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">PaymentConfirmed from Payment</span>
    <span class="pi">-</span> <span class="s">InventoryReserved from Inventory</span>
<span class="na">correlate</span><span class="pi">:</span> <span class="s">orderId</span>
<span class="na">And</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">both-approved</span><span class="pi">:</span> <span class="pi">&gt;</span>
      <span class="s">rm.events.PaymentConfirmed.status === 'captured' &amp;&amp;</span>
      <span class="s">rm.events.InventoryReserved.status === 'reserved'</span>
<span class="na">Then</span><span class="pi">:</span> <span class="s">ScheduleShipment -&gt; Fulfillment</span>
<span class="na">Outcome</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">correct-amount</span><span class="pi">:</span> <span class="pi">&gt;</span>
      <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
        <span class="s">.amount === rm.events.PaymentConfirmed.amount</span>
  <span class="pi">-</span> <span class="na">correct-lines</span><span class="pi">:</span> <span class="pi">&gt;</span>
      <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
        <span class="s">.lines === rm.events.InventoryReserved.reservedLines</span>
  <span class="pi">-</span> <span class="na">same-order</span><span class="pi">:</span> <span class="pi">&gt;</span>
      <span class="s">rm.events.PaymentConfirmed.orderId === rm.events.InventoryReserved.orderId</span>
</code></pre></div></div> <p>Rules:</p> <ul> <li><code class="language-plaintext highlighter-rouge">rm.events.&lt;EventName&gt;</code> is the concrete event type — no discrimination needed.</li> <li>Every event listed in <code class="language-plaintext highlighter-rouge">all</code> is guaranteed present when the reaction fires.</li> <li>The field name matches the event name exactly as declared in the <code class="language-plaintext highlighter-rouge">all</code> list.</li> <li><code class="language-plaintext highlighter-rouge">rm.event</code> (singular) is not available in <code class="language-plaintext highlighter-rouge">all</code> reactions. Use <code class="language-plaintext highlighter-rouge">rm.events</code>.</li> </ul> <h4 id="summary-1"> <a href="#summary-1" class="anchor-heading" aria-labelledby="summary-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h4> <div class="table-wrapper"><table> <thead> <tr> <th>When form</th> <th>Namespace</th> <th>Type</th> <th style="text-align: center">Narrowing needed</th> </tr> </thead> <tbody> <tr> <td>Scalar</td> <td><code class="language-plaintext highlighter-rouge">rm.event</code></td> <td>Concrete event type</td> <td style="text-align: center">No</td> </tr> <tr> <td>Any</td> <td><code class="language-plaintext highlighter-rouge">rm.event</code></td> <td>Discriminated union</td> <td style="text-align: center">Yes (<code class="language-plaintext highlighter-rouge">.kind</code>)</td> </tr> <tr> <td>All</td> <td><code class="language-plaintext highlighter-rouge">rm.events.EventName</code></td> <td>Each concrete type</td> <td style="text-align: center">No</td> </tr> </tbody> </table></div> <h3 id="72-rmstate--process-manager-state"> <a href="#72-rmstate--process-manager-state" class="anchor-heading" aria-labelledby="72-rmstate--process-manager-state"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2 rm.state — Process Manager State </h3> <p>Only for stateful sagas. The process manager’s own state before the reaction.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">not-already-tracking</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!(rm.event.registryId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">rm.state.pendingReassessments)"</span>
</code></pre></div></div> <p>Stateless reactors and reactions using <code class="language-plaintext highlighter-rouge">When: { all: [...] }</code> without custom state do not reference <code class="language-plaintext highlighter-rouge">rm.state</code>. The <code class="language-plaintext highlighter-rouge">all</code> trigger handles event accumulation automatically — the spec author does not need to manage saga state for the join pattern.</p> <h3 id="73-rmctx--shell-resolved-context"> <a href="#73-rmctx--shell-resolved-context" class="anchor-heading" aria-labelledby="73-rmctx--shell-resolved-context"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.3 rm.ctx — Shell-Resolved Context </h3> <p>Async context resolved before the reaction runs. Typically read-model queries — looking up the current state of target aggregates.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">has-assignment</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">rm.ctx.laboratory.assignments.some(a =&gt;</span>
      <span class="s">a.area.kind === rm.event.area.kind)</span>
  <span class="c1"># shell: LaboratoryReadModel.findById(rm.event.laboratoryId)</span>

<span class="pi">-</span> <span class="na">adjusted-profile-exists</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.ctx.adjustedProfileExists"</span>
  <span class="c1"># shell: RegistryReadModel.profileExists(rm.event.adjustedProfileId)</span>
</code></pre></div></div> <p>Convention: annotate with <code class="language-plaintext highlighter-rouge"># shell: &lt;resolution hint&gt;</code>.</p> <p>Note: <code class="language-plaintext highlighter-rouge">rm.ctx</code> queries target <strong>read models</strong>, which are eventually consistent. The spec should be written with this in mind — a reaction that depends on split-second consistency should be flagged.</p> <p>For <code class="language-plaintext highlighter-rouge">all</code> triggers, shell expressions can reference any event payload via <code class="language-plaintext highlighter-rouge">rm.events</code>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">current-stock</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.ctx.availableStock</span><span class="nv"> </span><span class="s">&gt;=</span><span class="nv"> </span><span class="s">rm.events.OrderPlaced.requestedQuantity"</span>
  <span class="c1"># shell: InventoryReadModel.getStock(rm.events.OrderPlaced.productId)</span>
</code></pre></div></div> <h3 id="74-derivations"> <a href="#74-derivations" class="anchor-heading" aria-labelledby="74-derivations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4 Derivations </h3> <p>An agent scans the specification to derive:</p> <ul> <li><strong>Context type per reaction</strong>: TypeScript type from <code class="language-plaintext highlighter-rouge">rm.ctx.*</code> paths.</li> <li><strong>Shell function per reaction</strong>: async function that resolves the context.</li> <li><strong>Event type for scalar/any</strong>: concrete type or discriminated union for <code class="language-plaintext highlighter-rouge">rm.event</code>.</li> <li><strong>Event record type for all</strong>: <code class="language-plaintext highlighter-rouge">{ PaymentConfirmed: PaymentConfirmedEvent; InventoryReserved: InventoryReservedEvent }</code> for <code class="language-plaintext highlighter-rouge">rm.events</code>.</li> <li><strong>Correlation key</strong>: from <code class="language-plaintext highlighter-rouge">correlate</code> field, verified present on all events.</li> <li><strong>Contract verification</strong>: <code class="language-plaintext highlighter-rouge">rm.event</code> / <code class="language-plaintext highlighter-rouge">rm.events</code> field paths checked against source decider event types. Command payloads checked against target decider command types.</li> </ul> <h2 id="8-outcome-model-om"> <a href="#8-outcome-model-om" class="anchor-heading" aria-labelledby="8-outcome-model-om"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Outcome Model (om) </h2> <p>The context for postcondition assertions.</p> <h3 id="81-omcommands--dispatched-commands"> <a href="#81-omcommands--dispatched-commands" class="anchor-heading" aria-labelledby="81-omcommands--dispatched-commands"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.1 om.commands — Dispatched Commands </h3> <p>The ordered list of commands to be dispatched. Each command has a <code class="language-plaintext highlighter-rouge">kind</code> field (the command name) and payload fields matching the target decider’s command type.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">review-triggered</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">om.commands.some(c =&gt;</span>
      <span class="s">c.kind === 'UpdateAssignment' &amp;&amp;</span>
      <span class="s">c.targetKind === 'UnderReview' &amp;&amp;</span>
      <span class="s">c.laboratoryId === rm.event.laboratoryId)</span>

<span class="pi">-</span> <span class="na">correct-count</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.commands.length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">2"</span>

<span class="pi">-</span> <span class="na">correct-order</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">om.commands.findIndex(c =&gt; c.kind === 'WithdrawAssignment') &lt;</span>
      <span class="s">om.commands.findIndex(c =&gt; c.kind === 'AssignProfile')</span>
</code></pre></div></div> <h3 id="82-omstate--process-manager-state-after"> <a href="#82-omstate--process-manager-state-after" class="anchor-heading" aria-labelledby="82-omstate--process-manager-state-after"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.2 om.state — Process Manager State After </h3> <p>Only for stateful sagas with custom state. The process manager’s state after the reaction.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">reassessments-tracked</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">om.state.pendingReassessments[rm.event.registryId]?.length ===</span>
      <span class="s">rm.ctx.affectedLaboratories.length</span>
</code></pre></div></div> <h3 id="83-cross-model-access"> <a href="#83-cross-model-access" class="anchor-heading" aria-labelledby="83-cross-model-access"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.3 Cross-Model Access </h3> <div class="table-wrapper"><table> <thead> <tr> <th>Namespace</th> <th>Available in</th> <th>Purpose</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">om.commands</code></td> <td>All reactions</td> <td>Commands dispatched — what will happen</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">om.state</code></td> <td>Stateful sagas</td> <td>New PM state</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">rm.event</code></td> <td>Scalar, Any</td> <td>Triggering event — data flow verification</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">rm.events</code></td> <td>All</td> <td>All triggering events — data flow verification</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">rm.state</code></td> <td>Stateful sagas</td> <td>Old PM state — before/after comparison</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">rm.ctx</code></td> <td>All reactions</td> <td>Resolved context — cross-referencing</td> </tr> </tbody> </table></div> <h3 id="84-outcome-completeness"> <a href="#84-outcome-completeness" class="anchor-heading" aria-labelledby="84-outcome-completeness"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.4 Outcome Completeness </h3> <p>A thorough Outcome includes:</p> <ol> <li><strong>Command presence</strong> — correct commands dispatched to correct targets</li> <li><strong>Command payload</strong> — data flows correctly from events to commands</li> <li><strong>Command ordering</strong> — sequence matters when target decider has dependencies</li> <li><strong>Command count</strong> — no unexpected extra commands</li> <li><strong>Correlation integrity</strong> (for <code class="language-plaintext highlighter-rouge">all</code>) — all events reference the same instance</li> <li><strong>State tracking</strong> (sagas) — correlation state updated correctly</li> </ol> <h2 id="9-stateless-vs-stateful"> <a href="#9-stateless-vs-stateful" class="anchor-heading" aria-labelledby="9-stateless-vs-stateful"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Stateless vs Stateful </h2> <h3 id="91-stateless-reactor"> <a href="#91-stateless-reactor" class="anchor-heading" aria-labelledby="91-stateless-reactor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.1 Stateless Reactor </h3> <p>Most process managers are stateless. They receive an event (or a completed set of events for <code class="language-plaintext highlighter-rouge">all</code>), optionally query context, and emit commands. No <code class="language-plaintext highlighter-rouge">state</code> section. No <code class="language-plaintext highlighter-rouge">rm.state</code> or <code class="language-plaintext highlighter-rouge">om.state</code> references.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">process/v1</span>
<span class="na">process</span><span class="pi">:</span> <span class="s">AssessmentLifecycleManager</span>
<span class="na">reacts_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">SelfAssessment</span><span class="pi">]</span>
<span class="na">emits_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Laboratory</span><span class="pi">]</span>
<span class="na">model</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./model.ts"</span>

<span class="na">reactions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AssessmentConfirmed</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">confirmed</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'UpdateAssignment' &amp;&amp;</span>
            <span class="s">c.targetKind === 'Confirmed')</span>
</code></pre></div></div> <p>Note: <code class="language-plaintext highlighter-rouge">When: { all: [...] }</code> reactions are also stateless from the spec author’s perspective. The runtime manages event accumulation. The spec describes what happens when all events are present — not how to accumulate them.</p> <h3 id="92-stateful-saga"> <a href="#92-stateful-saga" class="anchor-heading" aria-labelledby="92-stateful-saga"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.2 Stateful Saga </h3> <p>When a process manager needs custom state beyond what <code class="language-plaintext highlighter-rouge">all</code> provides — for example, tracking a dynamic set of expected events, implementing timeouts, or managing multi-step compensation — it declares a <code class="language-plaintext highlighter-rouge">state</code> section and uses <code class="language-plaintext highlighter-rouge">rm.state</code>/<code class="language-plaintext highlighter-rouge">om.state</code>.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">process/v1</span>
<span class="na">process</span><span class="pi">:</span> <span class="s">RegistryVersionManager</span>
<span class="na">reacts_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Registry</span><span class="pi">,</span> <span class="nv">Laboratory</span><span class="pi">]</span>
<span class="na">emits_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Laboratory</span><span class="pi">]</span>
<span class="na">model</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./model.ts"</span>

<span class="na">state</span><span class="pi">:</span>
  <span class="na">pendingReassessments</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Record&lt;string,</span><span class="nv"> </span><span class="s">string[]&gt;"</span>  <span class="c1"># registryId -&gt; labIds</span>

<span class="na">reactions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">RegistryArchived</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">Registry</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-affected-labs</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.ctx.affectedLaboratories.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">TriggerReassessment -&gt; Laboratory</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">reassessments-tracked</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.state.pendingReassessments[rm.event.registryId]?.length ===</span>
            <span class="s">rm.ctx.affectedLaboratories.length</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AssignmentReassessmentTriggered</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">Laboratory</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">is-tracked</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.registryId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">rm.state.pendingReassessments"</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">CompleteReassessmentCycle -&gt; Registry</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">all-done</span><span class="pi">:</span> <span class="pi">&gt;</span>
              <span class="s">rm.state.pendingReassessments[rm.event.registryId]</span>
                <span class="s">.filter(id =&gt; id !== rm.event.laboratoryId).length === 0</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="na">CompleteReassessmentCycle -&gt; Registry</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">tracking-cleared</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">!(rm.event.registryId in om.state.pendingReassessments)</span>
</code></pre></div></div> <h3 id="93-choosing"> <a href="#93-choosing" class="anchor-heading" aria-labelledby="93-choosing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.3 Choosing </h3> <div class="table-wrapper"><table> <thead> <tr> <th>Need</th> <th>Solution</th> </tr> </thead> <tbody> <tr> <td>React to one event</td> <td>Scalar When (stateless)</td> </tr> <tr> <td>React to one of several events</td> <td><code class="language-plaintext highlighter-rouge">When: { any: [...] }</code> (stateless)</td> </tr> <tr> <td>Wait for a known set of events</td> <td><code class="language-plaintext highlighter-rouge">When: { all: [...] }</code> (stateless)</td> </tr> <tr> <td>Track a dynamic set of events</td> <td>Custom <code class="language-plaintext highlighter-rouge">state</code> section (stateful saga)</td> </tr> <tr> <td>Implement timeouts or deadlines</td> <td>Custom <code class="language-plaintext highlighter-rouge">state</code> section (stateful saga)</td> </tr> <tr> <td>Multi-step compensation</td> <td>Custom <code class="language-plaintext highlighter-rouge">state</code> section (stateful saga)</td> </tr> </tbody> </table></div> <p>Prefer stateless. Use <code class="language-plaintext highlighter-rouge">all</code> before reaching for manual state. Only go stateful when the coordination logic cannot be expressed as a fixed set of awaited events.</p> <h2 id="10-interpretation"> <a href="#10-interpretation" class="anchor-heading" aria-labelledby="10-interpretation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Interpretation </h2> <h3 id="101-as-a-wiring-diagram"> <a href="#101-as-a-wiring-diagram" class="anchor-heading" aria-labelledby="101-as-a-wiring-diagram"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10.1 As a Wiring Diagram </h3> <p>The <code class="language-plaintext highlighter-rouge">reacts_to</code> and <code class="language-plaintext highlighter-rouge">emits_to</code> headers, combined with <code class="language-plaintext highlighter-rouge">When</code>/<code class="language-plaintext highlighter-rouge">From</code> and <code class="language-plaintext highlighter-rouge">Then -&gt; Target</code>, define the full event-command topology of the system:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DeciderA --[EventX]--&gt; ProcessManager --[CommandY]--&gt; DeciderB
                                      --[CommandZ]--&gt; DeciderC
</code></pre></div></div> <p>For <code class="language-plaintext highlighter-rouge">all</code> triggers, the diagram shows multiple inbound arrows converging:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Payment    --[PaymentConfirmed]---\
                                   --&gt; ReadyToShipManager --[ScheduleShipment]--&gt; Fulfillment
Inventory  --[InventoryReserved]--/
</code></pre></div></div> <p>An agent can extract the full topology from all Process UbiSpec and Lifecycle UbiSpec in the system.</p> <h3 id="102-as-test-cases"> <a href="#102-as-test-cases" class="anchor-heading" aria-labelledby="102-as-test-cases"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10.2 As Test Cases </h3> <p>Each reaction generates:</p> <ul> <li><strong>Happy path</strong>: given event(s) and context satisfying all constraints, assert correct commands dispatched with correct payloads and ordering.</li> <li><strong>Per-constraint no-op</strong>: for each constraint, given a violation, assert no commands dispatched.</li> <li><strong>Conditional command coverage</strong>: for each conditional command, test with conditions met and not met.</li> <li><strong><code class="language-plaintext highlighter-rouge">any</code> trigger coverage</strong>: for each event variant, test separately.</li> <li><strong><code class="language-plaintext highlighter-rouge">all</code> arrival order coverage</strong>: test all permutations of event arrival order.</li> <li><strong><code class="language-plaintext highlighter-rouge">all</code> correlation</strong>: verify events with different correlation values are handled independently.</li> <li><strong>Contract verification</strong>: command payloads type-check against target decider’s command types.</li> <li><strong>Ordering tests</strong>: when ordering assertions exist, verify sequence.</li> <li><strong>Saga state</strong> (if stateful): given events in sequence, verify state accumulation.</li> </ul> <h3 id="103-as-implementation-contract"> <a href="#103-as-implementation-contract" class="anchor-heading" aria-labelledby="103-as-implementation-contract"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10.3 As Implementation Contract </h3> <ul> <li><strong>react function</strong>: translates constraints and command conditions into code.</li> <li><strong>Shell function</strong>: derived from <code class="language-plaintext highlighter-rouge">rm.ctx</code> references.</li> <li><strong>Event subscription</strong>: derived from When + From. <code class="language-plaintext highlighter-rouge">any</code> subscribes to multiple events. <code class="language-plaintext highlighter-rouge">all</code> sets up accumulation with correlation.</li> <li><strong>Event types</strong>: concrete for scalar, discriminated union for <code class="language-plaintext highlighter-rouge">any</code>, record for <code class="language-plaintext highlighter-rouge">all</code>.</li> <li><strong>Correlation</strong>: from <code class="language-plaintext highlighter-rouge">correlate</code> field, verified present on all events in <code class="language-plaintext highlighter-rouge">all</code>.</li> <li><strong>Contract types</strong>: event types from source deciders, command types for target deciders.</li> <li><strong>Saga state machine</strong> (if stateful): state transitions derived from reactions.</li> </ul> <h2 id="11-complete-examples"> <a href="#11-complete-examples" class="anchor-heading" aria-labelledby="11-complete-examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. Complete Examples </h2> <h3 id="111-stateless-reactor-with-any-trigger"> <a href="#111-stateless-reactor-with-any-trigger" class="anchor-heading" aria-labelledby="111-stateless-reactor-with-any-trigger"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11.1 Stateless Reactor with <code class="language-plaintext highlighter-rouge">any</code> Trigger </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">process/v1</span>

<span class="na">process</span><span class="pi">:</span> <span class="s">AssessmentLifecycleManager</span>
<span class="na">reacts_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">SelfAssessment</span><span class="pi">]</span>
<span class="na">emits_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Laboratory</span><span class="pi">]</span>
<span class="na">model</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./model.ts"</span>

<span class="na">reactions</span><span class="pi">:</span>

  <span class="c1"># ── any: two events, same core reaction ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span>
      <span class="na">any</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">AssessmentSubmittedFullyMet</span><span class="pi">,</span> <span class="nv">AssessmentSubmittedWithGaps</span><span class="pi">]</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
      <span class="pi">-</span> <span class="na">ForwardGaps -&gt; Laboratory</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">has-gaps</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.event.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'AssessmentSubmittedWithGaps'"</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="na">_always</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">review-triggered</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">om.commands.some(c =&gt;</span>
              <span class="s">c.kind === 'UpdateAssignment' &amp;&amp;</span>
              <span class="s">c.targetKind === 'UnderReview' &amp;&amp;</span>
              <span class="s">c.laboratoryId === rm.event.laboratoryId)</span>
      <span class="na">ForwardGaps -&gt; Laboratory</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">gaps-forwarded</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">om.commands.find(c =&gt; c.kind === 'ForwardGaps')</span>
              <span class="s">.gaps === rm.event.gaps</span>

  <span class="c1"># ── Scalar: one event, one command ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AssessmentConfirmed</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assignment-confirmed</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'UpdateAssignment' &amp;&amp;</span>
            <span class="s">c.targetKind === 'Confirmed' &amp;&amp;</span>
            <span class="s">c.confirmedBy === rm.event.reviewedBy)</span>

  <span class="c1"># ── Ordered sequence ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AssessmentAdjusted</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">adjusted-profile-exists</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.ctx.adjustedProfileExists"</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">WithdrawAssignment -&gt; Laboratory</span>
      <span class="pi">-</span> <span class="s">AssignProfile -&gt; Laboratory</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">old-withdrawn</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'WithdrawAssignment' &amp;&amp;</span>
            <span class="s">c.area.kind === rm.event.area.kind)</span>
      <span class="pi">-</span> <span class="na">new-assigned</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'AssignProfile' &amp;&amp;</span>
            <span class="s">c.profileId === rm.event.adjustedProfileId &amp;&amp;</span>
            <span class="s">c.source === 'authority')</span>
      <span class="pi">-</span> <span class="na">correct-order</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.findIndex(c =&gt; c.kind === 'WithdrawAssignment') &lt;</span>
            <span class="s">om.commands.findIndex(c =&gt; c.kind === 'AssignProfile')</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AssessmentDevelopmentPlanIssued</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">development-plan-set</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'UpdateAssignment' &amp;&amp;</span>
            <span class="s">c.targetKind === 'Development' &amp;&amp;</span>
            <span class="s">c.actions === rm.event.actions)</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">RevisionRequested</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">UpdateAssignment -&gt; Laboratory</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assignment-reverted</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'UpdateAssignment' &amp;&amp;</span>
            <span class="s">c.targetKind === 'SelfAssessed')</span>

  <span class="c1"># ── Conditional command ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AssessmentCancelled</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">SelfAssessment</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">WithdrawAssignment -&gt; Laboratory</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">has-active-assignment</span><span class="pi">:</span> <span class="pi">&gt;</span>
              <span class="s">rm.ctx.laboratory.assignments.some(a =&gt;</span>
                <span class="s">a.area.kind === rm.event.area.kind &amp;&amp;</span>
                <span class="s">(a.kind === 'SelfAssessed' || a.kind === 'UnderReview'))</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="na">WithdrawAssignment -&gt; Laboratory</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">correct-area</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">om.commands.find(c =&gt; c.kind === 'WithdrawAssignment')</span>
              <span class="s">.area.kind === rm.event.area.kind</span>
</code></pre></div></div> <h3 id="112-cross-aggregate-join-with-all-trigger"> <a href="#112-cross-aggregate-join-with-all-trigger" class="anchor-heading" aria-labelledby="112-cross-aggregate-join-with-all-trigger"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11.2 Cross-Aggregate Join with <code class="language-plaintext highlighter-rouge">all</code> Trigger </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">process/v1</span>

<span class="na">process</span><span class="pi">:</span> <span class="s">ReadyToShipManager</span>
<span class="na">reacts_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Payment</span><span class="pi">,</span> <span class="nv">Inventory</span><span class="pi">]</span>
<span class="na">emits_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Fulfillment</span><span class="pi">]</span>
<span class="na">model</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./model.ts"</span>

<span class="na">reactions</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span>
      <span class="na">all</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">PaymentConfirmed from Payment</span>
        <span class="pi">-</span> <span class="s">InventoryReserved from Inventory</span>
    <span class="na">correlate</span><span class="pi">:</span> <span class="s">orderId</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">ScheduleShipment -&gt; Fulfillment</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">shipment-for-correct-order</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
            <span class="s">.orderId === rm.events.PaymentConfirmed.orderId</span>
      <span class="pi">-</span> <span class="na">uses-payment-amount</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
            <span class="s">.amount === rm.events.PaymentConfirmed.capturedAmount</span>
      <span class="pi">-</span> <span class="na">uses-reserved-lines</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.find(c =&gt; c.kind === 'ScheduleShipment')</span>
            <span class="s">.lines.length === rm.events.InventoryReserved.reservedLines.length</span>
      <span class="pi">-</span> <span class="na">single-command</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.commands.length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">1"</span>
</code></pre></div></div> <h3 id="113-same-decider-join-with-all-trigger"> <a href="#113-same-decider-join-with-all-trigger" class="anchor-heading" aria-labelledby="113-same-decider-join-with-all-trigger"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11.3 Same-Decider Join with <code class="language-plaintext highlighter-rouge">all</code> Trigger </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">process/v1</span>

<span class="na">process</span><span class="pi">:</span> <span class="s">OrderReadyForProcessingManager</span>
<span class="na">reacts_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Order</span><span class="pi">]</span>
<span class="na">emits_to</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Fulfillment</span><span class="pi">]</span>
<span class="na">model</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./model.ts"</span>

<span class="na">reactions</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span>
      <span class="na">all</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">OrderPlaced</span><span class="pi">,</span> <span class="nv">PaymentVerified</span><span class="pi">]</span>
    <span class="na">From</span><span class="pi">:</span> <span class="s">Order</span>
    <span class="na">correlate</span><span class="pi">:</span> <span class="s">orderId</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">no-fraud-flag</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rm.events.PaymentVerified.fraudScore</span><span class="nv"> </span><span class="s">&lt;</span><span class="nv"> </span><span class="s">0.7"</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">BeginFulfillment -&gt; Fulfillment</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">fulfillment-initiated</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.commands.some(c =&gt;</span>
            <span class="s">c.kind === 'BeginFulfillment' &amp;&amp;</span>
            <span class="s">c.orderId === rm.events.OrderPlaced.orderId &amp;&amp;</span>
            <span class="s">c.lines === rm.events.OrderPlaced.lines)</span>
</code></pre></div></div> <h2 id="12-grammar-summary"> <a href="#12-grammar-summary" class="anchor-heading" aria-labelledby="12-grammar-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 12. Grammar Summary </h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Document         := Header State? Common? Reactions
Header           := 'bspec: process/v1' Process ReactsTo EmitsTo Model
Process          := 'process:' ProcessName
ReactsTo         := 'reacts_to:' '[' DeciderName (',' DeciderName)* ']'
EmitsTo          := 'emits_to:' '[' DeciderName (',' DeciderName)* ']'
State            := 'state:' FieldMap
Common           := 'common:' PredicateMap
Reactions        := 'reactions:' Reaction+

Reaction         := Trigger And? Then Outcome

Trigger          := ScalarTrigger | AnyTrigger | AllTrigger
ScalarTrigger    := 'When:' EventName 'From:' DeciderName
AnyTrigger       := 'When:' '{' 'any:' EventList '}' 'From:' DeciderName
AllTrigger       := AllTriggerCross | AllTriggerShared
AllTriggerCross  := 'When:' '{' 'all:' SourcedEventList '}' 'correlate:' FieldName
AllTriggerShared := 'When:' '{' 'all:' EventList '}' 'From:' DeciderName 'correlate:' FieldName
EventList        := '[' EventName (',' EventName)+ ']'
SourcedEventList := SourcedEvent+
SourcedEvent     := '- ' EventName ' from ' DeciderName

And              := 'And:' Constraint+
Constraint       := PredicateEntry | CommonRef

Then             := ScalarThen | ListThen
ScalarThen       := 'Then:' TargetedCommand
ListThen         := 'Then:' CommandSpec+
CommandSpec      := UnconditionalCommand | ConditionalCommand
UnconditionalCommand  := '- ' TargetedCommand
ConditionalCommand    := '- ' TargetedCommand ':' PredicateEntry+
TargetedCommand  := CommandName ' -&gt; ' DeciderName

Outcome          := FlatOutcome | KeyedOutcome
FlatOutcome      := 'Outcome:' PredicateEntry+
KeyedOutcome     := 'Outcome:' AlwaysBlock? CommandOutcome+
AlwaysBlock      := '_always:' PredicateEntry+
CommandOutcome   := TargetedCommand ':' PredicateEntry+

PredicateEntry   := '- ' PredicateName ':' Expression
PredicateMap     := (PredicateName ':' Expression)+
FieldMap         := (FieldName ':' TypeExpression)+
PredicateName    := kebab-case-identifier
Expression       := TypeScript boolean expression over rm.* | om.*
ProcessName      := PascalCase identifier
DeciderName      := PascalCase identifier
EventName        := PascalCase identifier
CommandName      := PascalCase identifier
FieldName        := camelCase identifier
</code></pre></div></div> <h2 id="13-comparison-with-lifecycle-ubispec"> <a href="#13-comparison-with-lifecycle-ubispec" class="anchor-heading" aria-labelledby="13-comparison-with-lifecycle-ubispec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 13. Comparison with Lifecycle UbiSpec </h2> <div class="table-wrapper"><table> <thead> <tr> <th>Concept</th> <th>Lifecycle UbiSpec</th> <th>Process UbiSpec</th> </tr> </thead> <tbody> <tr> <td>Triggered by</td> <td>Command (<code class="language-plaintext highlighter-rouge">When</code>)</td> <td>Event(s) (<code class="language-plaintext highlighter-rouge">When</code> + <code class="language-plaintext highlighter-rouge">From</code>)</td> </tr> <tr> <td>Produces</td> <td>Events (<code class="language-plaintext highlighter-rouge">Then</code>)</td> <td>Commands (<code class="language-plaintext highlighter-rouge">Then</code> + <code class="language-plaintext highlighter-rouge">-&gt; Target</code>)</td> </tr> <tr> <td>Input model</td> <td><code class="language-plaintext highlighter-rouge">dm</code> (cmd, state, ctx)</td> <td><code class="language-plaintext highlighter-rouge">rm</code> (event/events, state, ctx)</td> </tr> <tr> <td>Output model</td> <td><code class="language-plaintext highlighter-rouge">om</code> (state, evts)</td> <td><code class="language-plaintext highlighter-rouge">om</code> (commands, state)</td> </tr> <tr> <td>Failure</td> <td><code class="language-plaintext highlighter-rouge">DecisionFailed</code> event</td> <td>No-op (silence)</td> </tr> <tr> <td>State</td> <td>Always (aggregate)</td> <td>Optional (saga)</td> </tr> <tr> <td>Identity</td> <td>Aggregate ID</td> <td>Correlation (from events)</td> </tr> <tr> <td>Topology</td> <td>Self-contained</td> <td>Declares <code class="language-plaintext highlighter-rouge">reacts_to</code> / <code class="language-plaintext highlighter-rouge">emits_to</code></td> </tr> <tr> <td>Single trigger</td> <td>One command</td> <td>Scalar: one event</td> </tr> <tr> <td>OR trigger</td> <td>N/A</td> <td><code class="language-plaintext highlighter-rouge">any</code>: one of several events</td> </tr> <tr> <td>AND trigger</td> <td>N/A</td> <td><code class="language-plaintext highlighter-rouge">all</code>: wait for all events + <code class="language-plaintext highlighter-rouge">correlate</code></td> </tr> </tbody> </table></div> <h2 id="14-versioning"> <a href="#14-versioning" class="anchor-heading" aria-labelledby="14-versioning"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 14. Versioning </h2> <p>Format: <code class="language-plaintext highlighter-rouge">process/v1</code>. Declared in the <code class="language-plaintext highlighter-rouge">bspec</code> header. Breaking changes increment the version.</p> </main> <hr> <footer> <p class="text-small mb-0">UbiSpec is open source under the MIT License.</p> <div class="d-md-none mt-4 fs-2"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
