<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Lifecycle UbiSpec | UbiSpec</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Lifecycle UbiSpec" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Behavioural Specification Format for Software Systems" /> <meta property="og:description" content="Behavioural Specification Format for Software Systems" /> <link rel="canonical" href="http://0.0.0.0:4000/spec/lifecycle.html" /> <meta property="og:url" content="http://0.0.0.0:4000/spec/lifecycle.html" /> <meta property="og:site_name" content="UbiSpec" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Lifecycle UbiSpec" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Behavioural Specification Format for Software Systems","headline":"Lifecycle UbiSpec","url":"http://0.0.0.0:4000/spec/lifecycle.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <header class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> UbiSpec </a> <button id="menu-button" class="site-button btn-reset" aria-label="Menu" aria-expanded="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/guide/conceptual-foundations.html" class="nav-list-link">Conceptual Foundations</a></li><li class="nav-list-item"><a href="/guide/getting-started.html" class="nav-list-link">Getting Started</a></li><li class="nav-list-item"><a href="/guide/guide.html" class="nav-list-link">Guide</a></li><li class="nav-list-item"><a href="/spec/lifecycle.html" class="nav-list-link">Lifecycle UbiSpec</a></li><li class="nav-list-item"><a href="/spec/process.html" class="nav-list-link">Process UbiSpec</a></li><li class="nav-list-item"><a href="/examples/" class="nav-list-link">Examples</a></li><li class="nav-list-item"><a href="/guide/example-artifacts.html" class="nav-list-link">Example artifacts</a></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/mean-machine-gc/bspec" class="nav-list-link external" > GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <div class="d-md-block d-none site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </div> </header> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search UbiSpec" autocomplete="off"> <label for="search-input" class="search-label"> <span class="sr-only">Search UbiSpec</span> <svg viewBox="0 0 24 24" class="search-icon" aria-hidden="true"><use xlink:href="#svg-search"></use></svg> </label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/mean-machine-gc/bspec" class="site-button" > GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="lifecycle-ubispec"> <a href="#lifecycle-ubispec" class="anchor-heading" aria-labelledby="lifecycle-ubispec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lifecycle UbiSpec </h1> <p><strong>Behavioural Specification Format for Event-Sourced Aggregate Deciders</strong></p> <p>Version: 0.2.0 Part of: UbiSpec (Behavioural Specification Format for Software Systems)</p><hr /> <h2 id="1-purpose"> <a href="#1-purpose" class="anchor-heading" aria-labelledby="1-purpose"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Purpose </h2> <p>A Lifecycle UbiSpec describes the complete behavioural contract of an event-sourced aggregate decider. It captures:</p> <ul> <li>Which commands the aggregate accepts</li> <li>Under what conditions each command is accepted or rejected</li> <li>Which events each command produces on success</li> <li>What must be true after those events are applied</li> </ul> <p>The spec is both human-readable (constraint names are natural language) and machine-executable (predicates are TypeScript expressions). It serves simultaneously as a domain conversation artifact, a test suite, and an implementation contract.</p> <p>A Lifecycle UbiSpec only describes <strong>success paths</strong>. Failure handling is implicit (§9).</p> <h2 id="2-scope"> <a href="#2-scope" class="anchor-heading" aria-labelledby="2-scope"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Scope </h2> <p>One Lifecycle UbiSpec per aggregate. Cross-aggregate coordination is specified separately in a Process UbiSpec.</p> <h2 id="3-relationship-to-model"> <a href="#3-relationship-to-model" class="anchor-heading" aria-labelledby="3-relationship-to-model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Relationship to Model </h2> <p>A Lifecycle UbiSpec references a TypeScript model file that defines all domain types. The model is the type authority. The spec is the behaviour authority. The spec does not define types.</p> <h2 id="4-document-structure"> <a href="#4-document-structure" class="anchor-heading" aria-labelledby="4-document-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Document Structure </h2> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">lifecycle/v1</span>

<span class="na">decider</span><span class="pi">:</span> <span class="s">&lt;AggregateName&gt;</span>
<span class="na">identity</span><span class="pi">:</span> <span class="s">&lt;identityFieldName&gt;</span>
<span class="na">model</span><span class="pi">:</span> <span class="s">&lt;path to TypeScript model file&gt;</span>

<span class="na">common</span><span class="pi">:</span>
  <span class="na">&lt;predicate-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>

<span class="na">lifecycle</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">&lt;CommandName&gt;</span>
    <span class="na">And</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">&lt;event specification&gt;</span>
    <span class="na">Outcome</span><span class="pi">:</span> <span class="s">&lt;assertions&gt;</span>
</code></pre></div></div> <h3 id="41-header"> <a href="#41-header" class="anchor-heading" aria-labelledby="41-header"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.1 Header </h3> <div class="table-wrapper"><table> <thead> <tr> <th>Field</th> <th>Required</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">bspec</code></td> <td>Yes</td> <td>Format identifier. Must be <code class="language-plaintext highlighter-rouge">lifecycle/v1</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">decider</code></td> <td>Yes</td> <td>Aggregate name. PascalCase.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">identity</code></td> <td>Yes</td> <td>Field that uniquely identifies aggregate instances.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">model</code></td> <td>Yes</td> <td>Relative path to the TypeScript model file.</td> </tr> </tbody> </table></div> <h3 id="42-common"> <a href="#42-common" class="anchor-heading" aria-labelledby="42-common"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.2 Common </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">common</span><span class="pi">:</span>
  <span class="na">&lt;predicate-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
</code></pre></div></div> <p>Optional. Reusable predicates referenced by bare name in <code class="language-plaintext highlighter-rouge">And</code> blocks. Each entry is a kebab-case name and a TypeScript boolean expression.</p> <h2 id="5-decision"> <a href="#5-decision" class="anchor-heading" aria-labelledby="5-decision"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Decision </h2> <p>Each element under <code class="language-plaintext highlighter-rouge">lifecycle</code> specifies one <strong>decision</strong> — the complete behaviour for one command, from acceptance through outcome.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">lifecycle</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">&lt;CommandName&gt;</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="s">&lt;constraints&gt;</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">&lt;events&gt;</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="s">&lt;assertions&gt;</span>
</code></pre></div></div> <h3 id="51-when"> <a href="#51-when" class="anchor-heading" aria-labelledby="51-when"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.1 When </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">When</span><span class="pi">:</span> <span class="s">&lt;CommandName&gt;</span>
</code></pre></div></div> <p>Names the command. One decision per command. PascalCase, must match a type in the model.</p> <h3 id="52-and--constraints"> <a href="#52-and--constraints" class="anchor-heading" aria-labelledby="52-and--constraints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.2 And — Constraints </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">And</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">&lt;constraint-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="pi">-</span> <span class="s">&lt;constraint-name&gt;</span>
</code></pre></div></div> <p>Constraints that must <strong>all</strong> hold for the command to succeed. If any constraint fails, the command produces a <code class="language-plaintext highlighter-rouge">DecisionFailed</code> event (§9) and no success events.</p> <p>Each entry is one of:</p> <ul> <li><strong>Inline</strong>: <code class="language-plaintext highlighter-rouge">name: expression</code> — name is natural language, expression is executable.</li> <li><strong>Common reference</strong>: <code class="language-plaintext highlighter-rouge">name</code> (bare, no value) — resolved from <code class="language-plaintext highlighter-rouge">common</code>.</li> </ul> <p>Constraints are evaluated against the <strong>Decision Model</strong> (§7).</p> <p><code class="language-plaintext highlighter-rouge">And</code> is optional. A command with no constraints always succeeds.</p> <h3 id="53-then--events"> <a href="#53-then--events" class="anchor-heading" aria-labelledby="53-then--events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.3 Then — Events </h3> <p>Specifies which events are produced on success. A command can produce one or more events.</p> <h4 id="scalar-form"> <a href="#scalar-form" class="anchor-heading" aria-labelledby="scalar-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scalar Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span> <span class="s">&lt;EventName&gt;</span>
</code></pre></div></div> <p>Shorthand. The command produces exactly this one event, unconditionally.</p> <h4 id="list-form"> <a href="#list-form" class="anchor-heading" aria-labelledby="list-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> List Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">&lt;EventName&gt;</span>
  <span class="pi">-</span> <span class="na">&lt;EventName&gt;</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">&lt;condition-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="pi">-</span> <span class="s">&lt;EventName&gt;</span>
</code></pre></div></div> <p>Each entry is an event that may or may not be emitted:</p> <ul> <li><strong>Unconditional event</strong>: bare event name. Always emitted on success.</li> <li><strong>Conditional event</strong>: event name with a list of <code class="language-plaintext highlighter-rouge">name: expression</code> conditions. Emitted only when <strong>all</strong> conditions hold.</li> </ul> <p>Rules:</p> <ul> <li><strong>All qualifying events are emitted.</strong> Every unconditional event fires. Every conditional event whose conditions all pass fires. This is not first-match-wins — it is additive.</li> <li>Conditions are evaluated against the <strong>Decision Model</strong> (§7), same as constraints.</li> <li>At least one event must be emitted on success. If all events are conditional and none match, this is a spec error (the constraints should have prevented this state).</li> <li>Events are emitted in list order. Order may matter for evolve.</li> </ul> <h4 id="patterns"> <a href="#patterns" class="anchor-heading" aria-labelledby="patterns"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Patterns </h4> <p><strong>Single unconditional event</strong> (most common):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span> <span class="s">TestEntryAdded</span>
</code></pre></div></div> <p><strong>Multiple unconditional events</strong> (batch):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">LaboratoryRegistered</span>
  <span class="pi">-</span> <span class="s">AuditTrailCreated</span>
</code></pre></div></div> <p><strong>Base event plus conditional extras</strong> (additive):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">RegistryApproved</span>
  <span class="pi">-</span> <span class="na">PreviousRegistryArchived</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-active-registry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.currentActiveRegistryId</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">null"</span>
</code></pre></div></div> <p><strong>Mutually exclusive events</strong> (alternative — predicates ensure exclusivity):</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">AssessmentSubmittedFullyMet</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">fully-met</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.overallResult</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'FullyMet'"</span>
  <span class="pi">-</span> <span class="na">AssessmentSubmittedWithGaps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-gaps</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.overallResult</span><span class="nv"> </span><span class="s">!==</span><span class="nv"> </span><span class="s">'FullyMet'"</span>
</code></pre></div></div> <p><strong>Mixed</strong>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Then</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">RegistryApproved</span>
  <span class="pi">-</span> <span class="na">PreviousRegistryArchived</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-active-registry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.currentActiveRegistryId</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">null"</span>
  <span class="pi">-</span> <span class="na">TransitionPeriodStarted</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">has-transition-period</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.transitionDays</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
</code></pre></div></div> <h3 id="54-outcome--assertions"> <a href="#54-outcome--assertions" class="anchor-heading" aria-labelledby="54-outcome--assertions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.4 Outcome — Assertions </h3> <p>Specifies what must be true after all emitted events have been applied (after evolve). Two forms:</p> <h4 id="flat-form"> <a href="#flat-form" class="anchor-heading" aria-labelledby="flat-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Flat Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Outcome</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
</code></pre></div></div> <p>A flat list. All assertions must hold after evolve. Use this when:</p> <ul> <li>Then is scalar (single event), or</li> <li>All assertions apply regardless of which conditional events fired.</li> </ul> <h4 id="keyed-form"> <a href="#keyed-form" class="anchor-heading" aria-labelledby="keyed-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Keyed Form </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Outcome</span><span class="pi">:</span>
  <span class="na">_always</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="na">&lt;EventName&gt;</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
  <span class="na">&lt;EventName&gt;</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">&lt;assertion-name&gt;</span><span class="pi">:</span> <span class="s">&lt;expression&gt;</span>
</code></pre></div></div> <p>Assertions grouped by relevance:</p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">_always</code></strong>: assertions that hold after every successful execution, regardless of which events were emitted.</li> <li><strong>Event-keyed sections</strong>: assertions that are evaluated <strong>only when that event was emitted</strong>. If the event’s conditions didn’t fire, its outcome section is skipped.</li> </ul> <p>Rules:</p> <ul> <li><code class="language-plaintext highlighter-rouge">_always</code> is optional. If present, it runs on every success.</li> <li>Event keys must match event names from <code class="language-plaintext highlighter-rouge">Then</code>.</li> <li>All assertions (both <code class="language-plaintext highlighter-rouge">_always</code> and event-specific) are evaluated against the <strong>final state</strong> after all emitted events have been evolved, in order.</li> <li>Assertions use the <strong>Outcome Model</strong> (§8).</li> </ul> <p>Flat form is syntactic shorthand — it is equivalent to putting all assertions in <code class="language-plaintext highlighter-rouge">_always</code>.</p> <h2 id="6-predicate-entry"> <a href="#6-predicate-entry" class="anchor-heading" aria-labelledby="6-predicate-entry"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Predicate Entry </h2> <p>The atomic element of the spec. Appears in <code class="language-plaintext highlighter-rouge">common</code>, <code class="language-plaintext highlighter-rouge">And</code>, <code class="language-plaintext highlighter-rouge">Then</code> conditions, and <code class="language-plaintext highlighter-rouge">Outcome</code>.</p> <h3 id="61-naming"> <a href="#61-naming" class="anchor-heading" aria-labelledby="61-naming"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6.1 Naming </h3> <p>Every predicate has a name — a kebab-case identifier that reads as natural language. The name is the specification. It carries the meaning across all audiences.</p> <ul> <li>Constraints: <code class="language-plaintext highlighter-rouge">registry-is-draft</code>, <code class="language-plaintext highlighter-rouge">reviewer-is-authorised</code>, <code class="language-plaintext highlighter-rouge">entry-exists-in-catalog</code></li> <li>Conditions: <code class="language-plaintext highlighter-rouge">has-active-registry</code>, <code class="language-plaintext highlighter-rouge">is-sampling-activity</code>, <code class="language-plaintext highlighter-rouge">has-downstream-refs</code></li> <li>Assertions: <code class="language-plaintext highlighter-rouge">state-is-active</code>, <code class="language-plaintext highlighter-rouge">entry-in-catalog</code>, <code class="language-plaintext highlighter-rouge">catalog-unchanged</code></li> </ul> <h3 id="62-detail-levels"> <a href="#62-detail-levels" class="anchor-heading" aria-labelledby="62-detail-levels"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6.2 Detail Levels </h3> <p>The value of a predicate — the part after the colon — can take four forms, from least to most precise. All four are valid UbiSpec. They represent a spectrum, not a hierarchy. Use the level that fits your stage and audience.</p> <h4 id="level-1-name-only"> <a href="#level-1-name-only" class="anchor-heading" aria-labelledby="level-1-name-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Level 1: Name Only </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">registry-is-draft</span>
</code></pre></div></div> <p>The constraint exists. The name says what it means. No further detail. This is the form used in the domain pass — the first pass where domain experts validate the behavioural logic. A specification with only Level 1 predicates is already a complete behavioural contract: it captures what commands exist, what conditions apply, what events are produced, and what outcomes are asserted.</p> <h4 id="level-2-scope-annotation"> <a href="#level-2-scope-annotation" class="anchor-heading" aria-labelledby="level-2-scope-annotation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Level 2: Scope Annotation </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">registry-is-draft</span><span class="pi">:</span> <span class="s">dm.state</span>
<span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s">dm.ctx</span>
<span class="pi">-</span> <span class="na">entry-matches-area</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">dm.cmd</span><span class="pi">,</span> <span class="nv">dm.state</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">state-is-active</span><span class="pi">:</span> <span class="s">om.state</span>
<span class="pi">-</span> <span class="na">event-carries-effective-date</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">om.evts</span><span class="pi">,</span> <span class="nv">dm.cmd</span><span class="pi">]</span>
</code></pre></div></div> <p>The predicate names which <strong>data sources</strong> are involved, without specifying how they are evaluated. This tells you:</p> <ul> <li><code class="language-plaintext highlighter-rouge">dm.state</code> — the constraint depends only on the aggregate’s current state.</li> <li><code class="language-plaintext highlighter-rouge">dm.ctx</code> — the constraint requires an external lookup (an async shell dependency).</li> <li><code class="language-plaintext highlighter-rouge">[dm.cmd, dm.state]</code> — the constraint compares the command payload against current state.</li> <li><code class="language-plaintext highlighter-rouge">om.state</code> — the assertion checks the new state after evolve.</li> <li><code class="language-plaintext highlighter-rouge">[om.evts, dm.cmd]</code> — the assertion verifies that event payloads carry data from the command.</li> </ul> <p>Scope annotations are language-agnostic. They work whether you’re implementing in TypeScript, Kotlin, F#, or describing the system in a document. They already provide architectural information: you know which constraints are pure (dm.state, dm.cmd), which require the shell (dm.ctx), and which assertions compare before/after state (om.state vs dm.state).</p> <h4 id="level-3-prose-description"> <a href="#level-3-prose-description" class="anchor-heading" aria-labelledby="level-3-prose-description"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Level 3: Prose Description </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">registry-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Registry</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">Draft</span><span class="nv"> </span><span class="s">status"</span>
<span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s2">"</span><span class="s">The</span><span class="nv"> </span><span class="s">reviewer</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">national</span><span class="nv"> </span><span class="s">authority</span><span class="nv"> </span><span class="s">(dm.ctx)"</span>
<span class="pi">-</span> <span class="na">entry-matches-area</span><span class="pi">:</span> <span class="s2">"</span><span class="s">The</span><span class="nv"> </span><span class="s">submitted</span><span class="nv"> </span><span class="s">entry's</span><span class="nv"> </span><span class="s">area</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">match</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">registry's</span><span class="nv"> </span><span class="s">area</span><span class="nv"> </span><span class="s">(dm.cmd,</span><span class="nv"> </span><span class="s">dm.state)"</span>
</code></pre></div></div> <p>The predicate describes the rule in natural language. Optionally annotates with scope. This is useful for teams that want specifications readable as documentation but aren’t ready or don’t need to write code expressions. The parenthetical scope annotation preserves the architectural information.</p> <h4 id="level-4-executable-expression"> <a href="#level-4-executable-expression" class="anchor-heading" aria-labelledby="level-4-executable-expression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Level 4: Executable Expression </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">registry-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Draft'"</span>
<span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.isNationalAuthority"</span>
<span class="pi">-</span> <span class="na">entry-matches-area</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.area.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">dm.state.area.kind"</span>
</code></pre></div></div> <p>The predicate is a boolean expression evaluable against the domain model. This is the most precise form — it can be validated against the model, used to generate tests, and used to generate implementation. Expressions must:</p> <ul> <li>Reference only <code class="language-plaintext highlighter-rouge">dm.*</code> or <code class="language-plaintext highlighter-rouge">om.*</code> namespaces</li> <li>Be pure (no side effects, no variables, no async)</li> <li>Use <code class="language-plaintext highlighter-rouge">?.</code> for optional fields, <code class="language-plaintext highlighter-rouge">?? default</code> for safe defaults</li> </ul> <p>The expression language used in this specification is TypeScript, chosen because it is widely readable and because it matches the domain model format. The UbiSpec structure (names, namespaces, When/And/Then/Outcome) is language-agnostic. Teams working in other languages can write expressions in their own syntax while using the same namespaces and the same specification structure.</p> <h3 id="63-mixing-levels"> <a href="#63-mixing-levels" class="anchor-heading" aria-labelledby="63-mixing-levels"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6.3 Mixing Levels </h3> <p>Levels can be mixed within a single spec. This is expected and encouraged — it reflects the natural state of evolving specifications:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">ApproveRegistry</span>
  <span class="na">And</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">registry-is-submitted</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'SubmittedForReview'"</span>   <span class="c1"># Level 4</span>
    <span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s">dm.ctx</span>                                            <span class="c1"># Level 2</span>
    <span class="pi">-</span> <span class="s">no-unresolved-comments</span>                                                    <span class="c1"># Level 1</span>
  <span class="na">Then</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">RegistryApproved</span>
    <span class="pi">-</span> <span class="na">PreviousRegistryArchived</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">has-active-registry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.currentActiveRegistryId</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">null"</span>         <span class="c1"># Level 4</span>
  <span class="na">Outcome</span><span class="pi">:</span>
    <span class="na">_always</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">state-is-active</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Active'"</span>                    <span class="c1"># Level 4</span>
      <span class="pi">-</span> <span class="na">effective-date-set</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">om.state</span><span class="pi">,</span> <span class="nv">dm.cmd</span><span class="pi">]</span>                                  <span class="c1"># Level 2</span>
    <span class="na">PreviousRegistryArchived</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">archival-target-correct</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Previous</span><span class="nv"> </span><span class="s">registry's</span><span class="nv"> </span><span class="s">ID</span><span class="nv"> </span><span class="s">matches</span><span class="nv"> </span><span class="s">context"</span>       <span class="c1"># Level 3</span>
</code></pre></div></div> <p>This spec is incomplete from an execution standpoint but complete from a behavioural standpoint. Every constraint is named. Most have scope or expressions. One is still prose. This is a legitimate intermediate state — and in practice, most specifications live here for a while.</p> <h3 id="64-common-predicates"> <a href="#64-common-predicates" class="anchor-heading" aria-labelledby="64-common-predicates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6.4 Common Predicates </h3> <p>Reusable predicates defined once in the <code class="language-plaintext highlighter-rouge">common</code> section:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">common</span><span class="pi">:</span>
  <span class="na">registry-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Draft'"</span>
  <span class="na">registry-is-submitted</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'SubmittedForReview'"</span>
</code></pre></div></div> <p>Referenced by bare name:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">And</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">registry-is-draft</span>
  <span class="pi">-</span> <span class="na">valid-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.name.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
</code></pre></div></div> <p>Common predicates can also use any detail level. A common predicate at Level 2 (<code class="language-plaintext highlighter-rouge">registry-is-draft: dm.state</code>) tells every consumer of that predicate which data source is involved.</p> <h2 id="7-decision-model-dm"> <a href="#7-decision-model-dm" class="anchor-heading" aria-labelledby="7-decision-model-dm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Decision Model (dm) </h2> <p>The input context for constraints and event conditions.</p> <h3 id="71-dmcmd--command-payload"> <a href="#71-dmcmd--command-payload" class="anchor-heading" aria-labelledby="71-dmcmd--command-payload"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1 dm.cmd — Command Payload </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">valid-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.name.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
<span class="pi">-</span> <span class="na">entry-id-unique</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!(dm.cmd.entryId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">dm.state.testCatalog)"</span>
</code></pre></div></div> <h3 id="72-dmstate--current-state-before"> <a href="#72-dmstate--current-state-before" class="anchor-heading" aria-labelledby="72-dmstate--current-state-before"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2 dm.state — Current State (before) </h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">registry-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Draft'"</span>
<span class="pi">-</span> <span class="na">has-profiles</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Object.keys(dm.state.profiles).length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
</code></pre></div></div> <h3 id="73-dmctx--shell-resolved-context"> <a href="#73-dmctx--shell-resolved-context" class="anchor-heading" aria-labelledby="73-dmctx--shell-resolved-context"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.3 dm.ctx — Shell-Resolved Context </h3> <p>Async context resolved <strong>before</strong> decide runs. Every <code class="language-plaintext highlighter-rouge">dm.ctx</code> reference is a shell contract.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.isNationalAuthority"</span>  <span class="c1"># shell: AuthorityService.check(dm.cmd.reviewedBy)</span>
<span class="pi">-</span> <span class="na">facility-exists</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.facilityExists"</span>               <span class="c1"># shell: FacilityRegistry.lookup(dm.cmd.facilityRegistryId)</span>
</code></pre></div></div> <p>Convention: annotate with <code class="language-plaintext highlighter-rouge"># shell: &lt;resolution hint&gt;</code> on first use.</p> <p>Rule: context must never carry information derivable from <code class="language-plaintext highlighter-rouge">dm.state</code>.</p> <h3 id="74-derivations"> <a href="#74-derivations" class="anchor-heading" aria-labelledby="74-derivations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4 Derivations </h3> <p>From a Lifecycle UbiSpec, an agent can mechanically derive:</p> <ul> <li><strong>Context type per command</strong>: scan all <code class="language-plaintext highlighter-rouge">dm.ctx.*</code> references → generate TypeScript type.</li> <li><strong>Shell function per command</strong>: one async function per command with context dependencies.</li> <li><strong>Command types</strong>: verify <code class="language-plaintext highlighter-rouge">dm.cmd.*</code> paths against the model.</li> </ul> <h2 id="8-outcome-model-om"> <a href="#8-outcome-model-om" class="anchor-heading" aria-labelledby="8-outcome-model-om"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Outcome Model (om) </h2> <p>The context for postcondition assertions.</p> <h3 id="81-omstate--state-after-evolve"> <a href="#81-omstate--state-after-evolve" class="anchor-heading" aria-labelledby="81-omstate--state-after-evolve"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.1 om.state — State After Evolve </h3> <p>The aggregate state after <strong>all</strong> emitted events have been evolved, in order.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">state-is-active</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Active'"</span>
<span class="pi">-</span> <span class="na">entry-in-catalog</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.entryId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">om.state.testCatalog"</span>
</code></pre></div></div> <h3 id="82-omevts--emitted-events"> <a href="#82-omevts--emitted-events" class="anchor-heading" aria-labelledby="82-omevts--emitted-events"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.2 om.evts — Emitted Events </h3> <p>The list of events produced by the decide function, in emission order.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">archival-event-present</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">om.evts.some(e =&gt; e.kind === 'PreviousRegistryArchived')</span>
<span class="pi">-</span> <span class="na">event-count</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.evts.length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">2"</span>
<span class="pi">-</span> <span class="na">event-carries-data</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">om.evts.find(e =&gt; e.kind === 'RegistryApproved')</span>
      <span class="s">.effectiveDate === dm.cmd.effectiveDate</span>
</code></pre></div></div> <h3 id="83-cross-model-access"> <a href="#83-cross-model-access" class="anchor-heading" aria-labelledby="83-cross-model-access"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.3 Cross-Model Access </h3> <p>Outcome assertions can reference both models:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Namespace</th> <th>Purpose</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">om.state</code></td> <td>New state — what changed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">om.evts</code></td> <td>Emitted events — what happened</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">dm.state</code></td> <td>Old state — before/after comparison</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">dm.cmd</code></td> <td>Original command — payload verification</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">dm.ctx</code></td> <td>Resolved context — cross-referencing</td> </tr> </tbody> </table></div> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Before/after comparison</span>
<span class="pi">-</span> <span class="na">catalog-grew</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">Object.keys(om.state.testCatalog).length ===</span>
      <span class="s">Object.keys(dm.state.testCatalog).length + 1</span>

<span class="c1"># Payload verification</span>
<span class="pi">-</span> <span class="na">event-carries-entry-id</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">om.evts.find(e =&gt; e.kind === 'TestEntryAdded')</span>
      <span class="s">.entryId === dm.cmd.entryId</span>
</code></pre></div></div> <h3 id="84-outcome-completeness"> <a href="#84-outcome-completeness" class="anchor-heading" aria-labelledby="84-outcome-completeness"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8.4 Outcome Completeness </h3> <p>A thorough Outcome includes:</p> <ol> <li><strong>Positive</strong> — what changed (state transitions, field values)</li> <li><strong>Negative</strong> — what must NOT change (unrelated state preserved)</li> <li><strong>Event payload</strong> — events carry correct data from command/context</li> <li><strong>Event composition</strong> — correct events were emitted (count, presence)</li> </ol> <h2 id="9-implicit-failure-convention"> <a href="#9-implicit-failure-convention" class="anchor-heading" aria-labelledby="9-implicit-failure-convention"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Implicit Failure Convention </h2> <p>A Lifecycle UbiSpec only describes success paths. Failure is handled by convention.</p> <h3 id="91-the-decisionfailed-event"> <a href="#91-the-decisionfailed-event" class="anchor-heading" aria-labelledby="91-the-decisionfailed-event"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.1 The DecisionFailed Event </h3> <p>When any constraint in <code class="language-plaintext highlighter-rouge">And</code> fails, the decide function emits a single event:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">kind</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DecisionFailed</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">decision</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>      <span class="c1">// the command name from When</span>
  <span class="nx">failed</span><span class="p">:</span> <span class="kr">string</span><span class="p">[],</span>      <span class="c1">// names of constraints that failed</span>
<span class="p">}</span>
</code></pre></div></div> <p>No other events are emitted. The evolve function does not modify state for <code class="language-plaintext highlighter-rouge">DecisionFailed</code> — the aggregate is unchanged.</p> <h3 id="92-why-this-works"> <a href="#92-why-this-works" class="anchor-heading" aria-labelledby="92-why-this-works"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.2 Why This Works </h3> <ul> <li>Every constraint has a <strong>name</strong> that reads as natural language. The failure payload is human-readable: <code class="language-plaintext highlighter-rouge">{ decision: "ApproveRegistry", failed: ["reviewer-is-authorised"] }</code>.</li> <li>The spec doesn’t need to enumerate failure events per command. The constraint names <strong>are</strong> the failure specification.</li> <li>Test generation for failures is mechanical: for each constraint, construct a state/command/context that violates it, assert <code class="language-plaintext highlighter-rouge">DecisionFailed</code> with that constraint name.</li> <li>UI error handling maps directly: the <code class="language-plaintext highlighter-rouge">failed</code> array tells the frontend which fields or conditions to highlight.</li> </ul> <h3 id="93-implementation"> <a href="#93-implementation" class="anchor-heading" aria-labelledby="93-implementation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.3 Implementation </h3> <p>The decide function follows this pattern:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">decide</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">):</span> <span class="nx">Event</span><span class="p">[]</span> <span class="p">{</span>
  <span class="c1">// 1. Evaluate all And constraints</span>
  <span class="kd">const</span> <span class="nx">failed</span> <span class="o">=</span> <span class="nf">evaluateConstraints</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">failed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[{</span> <span class="na">kind</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DecisionFailed</span><span class="dl">'</span><span class="p">,</span> <span class="na">decision</span><span class="p">:</span> <span class="nx">cmd</span><span class="p">.</span><span class="kd">type</span><span class="p">,</span> <span class="nx">failed</span> <span class="p">}];</span>
  <span class="p">}</span>

  <span class="c1">// 2. Evaluate Then conditions and emit qualifying events</span>
  <span class="kd">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// ... for each event in Then, check conditions, push if pass</span>
  <span class="k">return</span> <span class="nx">events</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="94-decisionfailed-and-evolve"> <a href="#94-decisionfailed-and-evolve" class="anchor-heading" aria-labelledby="94-decisionfailed-and-evolve"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9.4 DecisionFailed and Evolve </h3> <p>The evolve function must handle <code class="language-plaintext highlighter-rouge">DecisionFailed</code>:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">evolve</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">event</span><span class="p">):</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">DecisionFailed</span><span class="dl">'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">state</span><span class="p">;</span> <span class="c1">// no-op</span>
  <span class="c1">// ... normal event handling</span>
<span class="p">}</span>
</code></pre></div></div> <p>This is the only event that does not change state. It exists so that:</p> <ul> <li>The event stream records that a command was attempted and rejected (audit trail)</li> <li>Subscribers (including the UI) can observe failures</li> <li>The pattern stays consistent: every command produces at least one event</li> </ul> <h2 id="10-interpretation"> <a href="#10-interpretation" class="anchor-heading" aria-labelledby="10-interpretation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Interpretation </h2> <h3 id="101-as-a-decision-table"> <a href="#101-as-a-decision-table" class="anchor-heading" aria-labelledby="101-as-a-decision-table"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10.1 As a Decision Table </h3> <p>Each decision is a row:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Command</th> <th>Constraints (all pass?)</th> <th>Events (all matching)</th> <th>Assertions (all hold)</th> </tr> </thead> <tbody> <tr> <td>When</td> <td>And</td> <td>Then</td> <td>Outcome</td> </tr> <tr> <td><em>(fail)</em></td> <td><em>(any fail)</em></td> <td>DecisionFailed</td> <td><em>(state unchanged)</em></td> </tr> </tbody> </table></div> <h3 id="102-as-test-cases"> <a href="#102-as-test-cases" class="anchor-heading" aria-labelledby="102-as-test-cases"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10.2 As Test Cases </h3> <p>Each decision generates:</p> <ul> <li><strong>Success path</strong>: given (state, cmd, ctx) satisfying all constraints, when decide + evolve, then all qualifying events are emitted and all outcome assertions hold.</li> <li><strong>Per-constraint failure</strong>: for each constraint, given a violation, assert <code class="language-plaintext highlighter-rouge">DecisionFailed</code> with that constraint name and state unchanged.</li> <li><strong>Conditional event coverage</strong>: for each conditional event, test with conditions met (event present) and not met (event absent).</li> <li><strong>Event composition</strong>: when multiple events can fire, test all valid combinations.</li> <li><strong>Property-based</strong>: given any (state, cmd, ctx) satisfying all constraints, outcome assertions hold.</li> </ul> <h3 id="103-as-implementation-contract"> <a href="#103-as-implementation-contract" class="anchor-heading" aria-labelledby="103-as-implementation-contract"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10.3 As Implementation Contract </h3> <ul> <li><strong>decide function</strong>: constraints → guard. Then conditions → event selection. All qualifying events emitted.</li> <li><strong>evolve function</strong>: must produce state satisfying all outcome assertions after processing events in order.</li> <li><strong>shell function</strong>: derived from <code class="language-plaintext highlighter-rouge">dm.ctx</code> references. One per command with context dependencies.</li> <li><strong>DecisionFailed handler</strong>: mechanical, same for all aggregates.</li> </ul> <h2 id="11-complete-example"> <a href="#11-complete-example" class="anchor-heading" aria-labelledby="11-complete-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. Complete Example </h2> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bspec</span><span class="pi">:</span> <span class="s">lifecycle/v1</span>

<span class="na">decider</span><span class="pi">:</span> <span class="s">Registry</span>
<span class="na">identity</span><span class="pi">:</span> <span class="s">registryId</span>
<span class="na">model</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./model.ts"</span>

<span class="na">common</span><span class="pi">:</span>
  <span class="na">registry-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Draft'"</span>
  <span class="na">registry-is-submitted</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'SubmittedForReview'"</span>

<span class="na">lifecycle</span><span class="pi">:</span>

  <span class="c1"># ── Simple: one unconditional event ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">CreateRegistry</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">no-existing-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!dm.ctx.existingDraftId"</span>  <span class="c1"># shell: RegistryRepo.findDraftId()</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">RegistryCreated</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">state-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Draft'"</span>
      <span class="pi">-</span> <span class="na">empty-catalog</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Object.keys(om.state.testCatalog).length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">0"</span>
      <span class="pi">-</span> <span class="na">empty-capabilities</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Object.keys(om.state.capabilities).length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">0"</span>
      <span class="pi">-</span> <span class="na">empty-profiles</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Object.keys(om.state.profiles).length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">0"</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">AddTestEntry</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">registry-is-draft</span>
      <span class="pi">-</span> <span class="na">entry-id-unique</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!(dm.cmd.entryId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">dm.state.testCatalog)"</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">TestEntryAdded</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">entry-in-catalog</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.entryId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">om.state.testCatalog"</span>
      <span class="pi">-</span> <span class="na">catalog-grew</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">Object.keys(om.state.testCatalog).length ===</span>
            <span class="s">Object.keys(dm.state.testCatalog).length + 1</span>
      <span class="pi">-</span> <span class="na">capabilities-unchanged</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">Object.keys(om.state.capabilities).length ===</span>
            <span class="s">Object.keys(dm.state.capabilities).length</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">SubmitForReview</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">registry-is-draft</span>
      <span class="pi">-</span> <span class="na">has-profiles</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Object.keys(dm.state.profiles).length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
      <span class="pi">-</span> <span class="na">all-capability-refs-valid</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">Object.values(dm.state.profiles).every(p =&gt;</span>
            <span class="s">p.requiredCapabilities.every(ref =&gt;</span>
              <span class="s">ref.id in dm.state.capabilities))</span>
      <span class="pi">-</span> <span class="na">all-entry-refs-valid</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">Object.values(dm.state.capabilities)</span>
            <span class="s">.flatMap(c =&gt; c.entries ?? [])</span>
            <span class="s">.every(ref =&gt; ref.id in dm.state.testCatalog)</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">RegistrySubmittedForReview</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">state-is-submitted</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'SubmittedForReview'"</span>
      <span class="pi">-</span> <span class="na">submitted-date-recorded</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.submittedDate</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">null"</span>
      <span class="pi">-</span> <span class="na">catalog-unchanged</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">Object.keys(om.state.testCatalog).length ===</span>
            <span class="s">Object.keys(dm.state.testCatalog).length</span>

  <span class="c1"># ── Additive: base event plus conditional extra ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">ApproveRegistry</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">registry-is-submitted</span>
      <span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.isNationalAuthority"</span>  <span class="c1"># shell: AuthorityService.check(dm.cmd.reviewedBy)</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">RegistryApproved</span>
      <span class="pi">-</span> <span class="na">PreviousRegistryArchived</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">has-active-registry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.currentActiveRegistryId</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">null"</span>  <span class="c1"># shell: RegistryRepo.findActiveId()</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="na">_always</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">state-is-active</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Active'"</span>
        <span class="pi">-</span> <span class="na">effective-date-set</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.effectiveDate</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">dm.cmd.effectiveDate"</span>
        <span class="pi">-</span> <span class="na">approval-event-carries-data</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">om.evts.find(e =&gt; e.kind === 'RegistryApproved')</span>
              <span class="s">.effectiveDate === dm.cmd.effectiveDate</span>
      <span class="na">PreviousRegistryArchived</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">archival-target-correct</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">om.evts.find(e =&gt; e.kind === 'PreviousRegistryArchived')</span>
              <span class="s">.registryId === dm.ctx.currentActiveRegistryId</span>
        <span class="pi">-</span> <span class="na">archival-superseded-by-self</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">om.evts.find(e =&gt; e.kind === 'PreviousRegistryArchived')</span>
              <span class="s">.supersededBy === dm.state.registryId</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">RejectRegistry</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">registry-is-submitted</span>
      <span class="pi">-</span> <span class="na">reviewer-is-authorised</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.isNationalAuthority"</span>
      <span class="pi">-</span> <span class="na">has-reason</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.reason.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
    <span class="na">Then</span><span class="pi">:</span> <span class="s">RegistryRejected</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">state-is-draft</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Draft'"</span>
      <span class="pi">-</span> <span class="na">rejection-carries-reason</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">om.evts.find(e =&gt; e.kind === 'RegistryRejected')</span>
            <span class="s">.reason === dm.cmd.reason</span>

  <span class="c1"># ── Alternative: mutually exclusive events ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">SubmitAssessment</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">assessment-in-progress</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'InProgress'"</span>
      <span class="pi">-</span> <span class="na">all-requirements-responded</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.allRequirementsResponded"</span>  <span class="c1"># shell: completeness check</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">AssessmentSubmittedFullyMet</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">fully-met</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.overallResult</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'FullyMet'"</span>
      <span class="pi">-</span> <span class="na">AssessmentSubmittedWithGaps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">has-gaps</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.overallResult</span><span class="nv"> </span><span class="s">!==</span><span class="nv"> </span><span class="s">'FullyMet'"</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="na">_always</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">state-is-submitted</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Submitted'"</span>
      <span class="na">AssessmentSubmittedFullyMet</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">result-recorded</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.overallResult</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'FullyMet'"</span>
      <span class="na">AssessmentSubmittedWithGaps</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">gaps-recorded</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.gaps.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
        <span class="pi">-</span> <span class="na">result-recorded</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.overallResult</span><span class="nv"> </span><span class="s">!==</span><span class="nv"> </span><span class="s">'FullyMet'"</span>

  <span class="c1"># ── Batch: multiple unconditional events ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">RegisterLaboratory</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">valid-facility-ref</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.ctx.facilityExists"</span>  <span class="c1"># shell: FacilityRegistry.lookup(dm.cmd.facilityRegistryId)</span>
      <span class="pi">-</span> <span class="na">unique-facility-binding</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!dm.ctx.facilityAlreadyBound"</span>  <span class="c1"># shell: LaboratoryRepo.findByFacility(dm.cmd.facilityRegistryId)</span>
      <span class="pi">-</span> <span class="na">valid-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.name.length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">LaboratoryRegistered</span>
      <span class="pi">-</span> <span class="s">AuditTrailCreated</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">state-is-planned</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.status.kind</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">'Planned'"</span>
      <span class="pi">-</span> <span class="na">name-set</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.name</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">dm.cmd.name"</span>
      <span class="pi">-</span> <span class="na">facility-bound</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.facilityRegistryId</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">dm.cmd.facilityRegistryId"</span>
      <span class="pi">-</span> <span class="na">no-assignments</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.state.assignments.length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">0"</span>
      <span class="pi">-</span> <span class="na">two-events</span><span class="pi">:</span> <span class="s2">"</span><span class="s">om.evts.length</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">2"</span>

  <span class="c1"># ── Mixed: unconditional + conditional + conditional ──</span>

  <span class="pi">-</span> <span class="na">When</span><span class="pi">:</span> <span class="s">RemoveCapability</span>
    <span class="na">And</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">registry-is-draft</span>
      <span class="pi">-</span> <span class="na">capability-exists</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dm.cmd.capabilityId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">dm.state.capabilities"</span>
      <span class="pi">-</span> <span class="na">no-profile-refs</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">!Object.values(dm.state.profiles).some(p =&gt;</span>
            <span class="s">p.requiredCapabilities.some(ref =&gt; ref.id === dm.cmd.capabilityId) ||</span>
            <span class="s">(p.allowedCapabilities ?? []).some(ref =&gt; ref.id === dm.cmd.capabilityId))</span>
    <span class="na">Then</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">CapabilityRemoved</span>
      <span class="pi">-</span> <span class="na">ChildCapabilitiesRemoved</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">has-children</span><span class="pi">:</span> <span class="s2">"</span><span class="s">(dm.state.capabilities[dm.cmd.capabilityId].children</span><span class="nv"> </span><span class="s">??</span><span class="nv"> </span><span class="s">[]).length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0"</span>
    <span class="na">Outcome</span><span class="pi">:</span>
      <span class="na">_always</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">capability-gone</span><span class="pi">:</span> <span class="s2">"</span><span class="s">!(dm.cmd.capabilityId</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">om.state.capabilities)"</span>
        <span class="pi">-</span> <span class="na">test-entries-preserved</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">Object.keys(dm.state.testCatalog).every(id =&gt; id in om.state.testCatalog)</span>
      <span class="na">ChildCapabilitiesRemoved</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">children-gone</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">dm.state.capabilities[dm.cmd.capabilityId].children</span>
              <span class="s">.every(child =&gt; !(child.id in om.state.capabilities))</span>
</code></pre></div></div> <h2 id="12-grammar-summary"> <a href="#12-grammar-summary" class="anchor-heading" aria-labelledby="12-grammar-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 12. Grammar Summary </h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Document         := Header Common? Lifecycle
Header           := 'bspec: lifecycle/v1' Decider Identity Model
Common           := 'common:' PredicateMap
Lifecycle        := 'lifecycle:' Decision+

Decision         := When And? Then Outcome

When             := 'When:' CommandName
And              := 'And:' Constraint+
Constraint       := PredicateEntry | CommonRef
CommonRef        := '- ' PredicateName

Then             := ScalarThen | ListThen
ScalarThen       := 'Then:' EventName
ListThen         := 'Then:' EventSpec+
EventSpec        := UnconditionalEvent | ConditionalEvent
UnconditionalEvent := '- ' EventName
ConditionalEvent := '- ' EventName ':' PredicateEntry+

Outcome          := FlatOutcome | KeyedOutcome
FlatOutcome      := 'Outcome:' PredicateEntry+
KeyedOutcome     := 'Outcome:' AlwaysBlock? EventOutcome+
AlwaysBlock      := '_always:' PredicateEntry+
EventOutcome     := EventName ':' PredicateEntry+

PredicateEntry   := '- ' PredicateName ':' Expression
PredicateMap     := (PredicateName ':' Expression)+
PredicateName    := kebab-case-identifier
Expression       := TypeScript boolean expression over dm.* | om.*
CommandName      := PascalCase identifier
EventName        := PascalCase identifier
</code></pre></div></div> <h2 id="13-versioning"> <a href="#13-versioning" class="anchor-heading" aria-labelledby="13-versioning"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 13. Versioning </h2> <p>Format: <code class="language-plaintext highlighter-rouge">lifecycle/v1</code>. Declared in the <code class="language-plaintext highlighter-rouge">bspec</code> header. Breaking changes increment the version.</p> </main> <hr> <footer> <p class="text-small mb-0">UbiSpec is open source under the MIT License.</p> <div class="d-md-none mt-4 fs-2"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
