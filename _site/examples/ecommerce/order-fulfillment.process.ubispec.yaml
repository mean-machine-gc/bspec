# yaml-language-server: $schema=../../schema/process.v1.schema.json

bspec: process/v1

process: OrderFulfillmentManager
reacts_to: [Order, Payment, Inventory]
emits_to: [Inventory, Payment, Fulfillment, Notification]
model: "./model.ts"

reactions:

  # ── Scalar: order placed triggers reservation and payment ──

  - When: OrderPlaced
    From: Order
    Then:
      - ReserveInventory -> Inventory
      - InitiatePaymentCapture -> Payment
    Outcome:
      - inventory-reservation-requested: >
          om.commands.some(c =>
            c.kind === 'ReserveInventory' &&
            c.orderId === rm.event.orderId &&
            c.lines.length === rm.event.lines.length)
      - payment-initiated: >
          om.commands.some(c =>
            c.kind === 'InitiatePaymentCapture' &&
            c.orderId === rm.event.orderId)
      - reserve-before-pay: >
          om.commands.findIndex(c => c.kind === 'ReserveInventory') <
            om.commands.findIndex(c => c.kind === 'InitiatePaymentCapture')

  # ── Scalar: high value flag triggers compliance review ──

  - When: HighValueOrderFlagged
    From: Order
    Then: SendReviewNotification -> Notification
    Outcome:
      - notification-sent: >
          om.commands.some(c =>
            c.kind === 'SendReviewNotification' &&
            c.orderId === rm.event.orderId &&
            c.channel === 'compliance')

  # ── all: wait for BOTH payment and inventory before scheduling shipment ──

  - When:
      all:
        - PaymentConfirmed from Payment
        - InventoryReserved from Inventory
    correlate: orderId
    Then: ScheduleShipment -> Fulfillment
    Outcome:
      - shipment-for-correct-order: >
          om.commands.find(c => c.kind === 'ScheduleShipment')
            .orderId === rm.events.PaymentConfirmed.orderId
      - uses-payment-amount: >
          om.commands.find(c => c.kind === 'ScheduleShipment')
            .amount === rm.events.PaymentConfirmed.capturedAmount
      - uses-reserved-lines: >
          om.commands.find(c => c.kind === 'ScheduleShipment')
            .lines.length === rm.events.InventoryReserved.reservedLines.length
      - single-command: "om.commands.length === 1"

  # ── Scalar: shipped triggers notification ──

  - When: OrderShipped
    From: Order
    Then: SendNotification -> Notification
    Outcome:
      - shipping-notification: >
          om.commands.some(c =>
            c.kind === 'SendNotification' &&
            c.template === 'order-shipped' &&
            c.trackingNumber === rm.event.trackingNumber)

  # ── Scalar: delivered triggers notification ──

  - When: OrderDelivered
    From: Order
    Then: SendNotification -> Notification
    Outcome:
      - delivery-notification: >
          om.commands.some(c =>
            c.kind === 'SendNotification' &&
            c.template === 'order-delivered')

  # ── Scalar: cancellation with conditional refund ──

  - When: OrderCancelled
    From: Order
    Then:
      - ReleaseInventory -> Inventory
      - InitiateRefund -> Payment:
          - payment-was-captured: "rm.ctx.paymentCaptured"
      - SendNotification -> Notification
    Outcome:
      _always:
        - inventory-released: >
            om.commands.some(c =>
              c.kind === 'ReleaseInventory' &&
              c.orderId === rm.event.orderId)
        - cancellation-notification: >
            om.commands.some(c =>
              c.kind === 'SendNotification' &&
              c.template === 'order-cancelled')
      InitiateRefund -> Payment:
        - refund-requested: >
            om.commands.find(c => c.kind === 'InitiateRefund')
              .orderId === rm.event.orderId

  # ── Scalar: auto-approved refund triggers payment processing ──

  - When: FullRefundApproved
    From: Order
    Then:
      - ProcessRefund -> Payment
      - SendNotification -> Notification
    Outcome:
      - refund-processed: >
          om.commands.some(c =>
            c.kind === 'ProcessRefund' &&
            c.orderId === rm.event.orderId)
      - refund-notification: >
          om.commands.some(c =>
            c.kind === 'SendNotification' &&
            c.template === 'refund-approved')
