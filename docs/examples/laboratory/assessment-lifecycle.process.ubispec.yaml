# yaml-language-server: $schema=../../schema/process.v1.schema.json

bspec: process/v1

process: AssessmentLifecycleManager
reacts_to: [SelfAssessment]
emits_to: [Laboratory]
model: "./model.ts"

reactions:

  # ── any: both submission outcomes trigger the same review flow ──

  - When:
      any: [AssessmentSubmittedFullyMet, AssessmentSubmittedWithGaps]
    From: SelfAssessment
    Then:
      - UpdateAssignment -> Laboratory
      - ForwardGaps -> Laboratory:
          - has-gaps: "rm.event.kind === 'AssessmentSubmittedWithGaps'"
    Outcome:
      _always:
        - review-triggered: >
            om.commands.some(c =>
              c.kind === 'UpdateAssignment' &&
              c.targetKind === 'UnderReview' &&
              c.laboratoryId === rm.event.laboratoryId)
      ForwardGaps -> Laboratory:
        - gaps-forwarded: >
            om.commands.find(c => c.kind === 'ForwardGaps')
              .gaps === rm.event.gaps

  # ── Scalar: authority confirms ──

  - When: AssessmentConfirmed
    From: SelfAssessment
    Then: UpdateAssignment -> Laboratory
    Outcome:
      - assignment-confirmed: >
          om.commands.some(c =>
            c.kind === 'UpdateAssignment' &&
            c.targetKind === 'Confirmed' &&
            c.confirmedBy === rm.event.reviewedBy)

  # ── Ordered: withdraw then assign ──

  - When: AssessmentAdjusted
    From: SelfAssessment
    And:
      - adjusted-profile-exists: "rm.ctx.adjustedProfileExists"
    Then:
      - WithdrawAssignment -> Laboratory
      - AssignProfile -> Laboratory
    Outcome:
      - old-withdrawn: >
          om.commands.some(c =>
            c.kind === 'WithdrawAssignment' &&
            c.area.kind === rm.event.area.kind)
      - new-assigned: >
          om.commands.some(c =>
            c.kind === 'AssignProfile' &&
            c.profileId === rm.event.adjustedProfileId &&
            c.source === 'authority')
      - correct-order: >
          om.commands.findIndex(c => c.kind === 'WithdrawAssignment') <
            om.commands.findIndex(c => c.kind === 'AssignProfile')

  - When: AssessmentDevelopmentPlanIssued
    From: SelfAssessment
    Then: UpdateAssignment -> Laboratory
    Outcome:
      - development-plan-set: >
          om.commands.some(c =>
            c.kind === 'UpdateAssignment' &&
            c.targetKind === 'Development' &&
            c.actions === rm.event.actions)

  - When: RevisionRequested
    From: SelfAssessment
    Then: UpdateAssignment -> Laboratory
    Outcome:
      - assignment-reverted: >
          om.commands.some(c =>
            c.kind === 'UpdateAssignment' &&
            c.targetKind === 'SelfAssessed')

  # ── Conditional: only withdraw if there's an active assignment ──

  - When: AssessmentCancelled
    From: SelfAssessment
    Then:
      - WithdrawAssignment -> Laboratory:
          - has-active-assignment: >
              rm.ctx.laboratory.assignments.some(a =>
                a.area.kind === rm.event.area.kind &&
                (a.kind === 'SelfAssessed' || a.kind === 'UnderReview'))
    Outcome:
      WithdrawAssignment -> Laboratory:
        - correct-area: >
            om.commands.find(c => c.kind === 'WithdrawAssignment')
              .area.kind === rm.event.area.kind
